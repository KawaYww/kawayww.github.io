<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æŸ³ä¸Šå·</title><meta name="description" content="æŸ³ä¸Šå·çš„åšå®¢"/><link rel="shortcut icon" href="/images/blog/avatar.avif" type="image/avif"/><link rel="stylesheet" href="/styles/highlight.min.css"/><link rel="stylesheet" href="/fonts/MapleMono-NF-CN-Regular/result.css"/><link rel="stylesheet" href="/fonts/MapleMono-NF-CN-Italic/result.css"/><link rel="stylesheet" href="/fonts/MapleMono-NF-CN-Bold/result.css"/><link rel="stylesheet" href="/styles/catppuccin-macchiato.css"/><link rel="stylesheet" href="/iconfonts/iconfont.css"/><link rel="stylesheet" href="/styles/tailwind.css"/><script src="/scripts/highlight.min.js"> </script><script src="/scripts/rust.min.js"> </script><script src="/scripts/nix.min.js"> </script><script src="/scripts/scheme.min.js"> </script><script src="/scripts/htmx.min.js"> </script><script src="/scripts/prefetch.js"> </script><script src="/scripts/custom.js"> </script><meta name="darkreader-lock"></head>
  <body>
    <div id="content" class="flex flex-col mx-4 mb-20 scroll-smooth" lang="zh-Hans">
      <div class="text-2xl sm:text-3xl my-4 w-full text-center">ã€rust-typed-magic: æŸ¯é‡ŒåŒ–æŸ¯é‡ŒåŒ–ä¸è¿‡ç¨‹è¿‡ç¨‹å®ã€</div>
      <div class="font-medium w-fit sm:mx-auto flex flex-col border-l-4 pl-2 sm:flex-row sm:border-l-0 sm:pl-0">
        <p>[å†™è‡ª:2024-03-02</p>
        <div class="px-2 hidden sm:inline">â”‚</div>
        <p>ä½œè€…:æŸ³ä¸Šå·</p>
        <div class="px-2 hidden sm:inline">â”‚</div>
        <p>ç³»åˆ—:<a class="underline underline-offset-5" href="/categories/rust-typed-magic" hx-get="/categories/rust-typed-magic/index.html" hx-target="body" hx-push-url="/categories/rust-typed-magic" hx-swap="innerHTML show:window:top">rust-typed-magic</a>]</p>
      </div>
      <div class="flex flex-col items-center m-4">
        <div class="w-fit mx-auto text-lg font-semibold">æ‘˜è¦</div>
        <div class="w-fit break-keep text-center sm:mx-[25%] *:inline">å­¦ä¹ é—­åŒ…ä¸å‡½æ•°, äº†è§£æŸ¯é‡ŒåŒ–çš„æ¦‚å¿µ, æœ€åä½¿ç”¨è¿‡ç¨‹å®ä½œä¸ºå¤§æ€å™¨, è‡ªåŠ¨ç”ŸæˆæŸ¯é‡ŒåŒ–å‡½æ•°å§</div>
      </div>
      <div class="flex flex-col my-10 w-fit border-2 border-slate-500">
        <p><span class="text-2xl">ç›®å½•:</span></p>
        <div class="w-fit pr-2 my-2">
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”Œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#cheng-pin-yan-shi">æˆå“æ¼”ç¤º</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#han-shu">å‡½æ•°</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â”€â”€</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#han-shu-xiang-yu-zhi-zhen">å‡½æ•°é¡¹ä¸æŒ‡é’ˆ</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â”€â”€</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#you-shi-and-que-xian">ä¼˜åŠ¿ and ç¼ºé™·</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#bi-bao">é—­åŒ…</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â”€â”€</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#bu-huo-zi-you-bian-liang">æ•è·è‡ªç”±å˜é‡</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â”€â”€</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#traitde-shi-xian">traitçš„å®ç°</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â”€â”€</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#ni-ming-lei-xing-sheng-cheng">åŒ¿åç±»å‹ç”Ÿæˆ</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â”€â”€</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#qiang-zhi-zhuan-yi-suo-you-quan">å¼ºåˆ¶è½¬ç§»æ‰€æœ‰æƒ</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#ke-li-hua">æŸ¯é‡ŒåŒ–</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#guo-cheng-hong">è¿‡ç¨‹å®</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â”€â”€</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#yuan-bian-cheng-de-jian-jie">å…ƒç¼–ç¨‹çš„ç®€ä»‹</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â”€â”€</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#guo-cheng-hong-de-shi-yong">è¿‡ç¨‹å®çš„ä½¿ç”¨</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â”€â”€</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#rang-hong-zhi-chi-fan-xing">è®©å®æ”¯æŒæ³›å‹</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â””â”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#zi-dong-tui-dao-lei-xing">è‡ªåŠ¨æ¨å¯¼ç±»å‹</a></span></div>
        </div>
      </div>
      <p>å‰ç½®çŸ¥è¯†: rust åŸºç¡€è¯­æ³•<br>å®Œæ•´ä»£ç : <a class="underline underline-offset-5 font-medium" href="https://github.com/Jedsek/curried">curried</a><br><br><em>æ³¨æ„</em>:<br>æ­¤ç¯‡ä»£ç çš„ç›®çš„å¹¶ä¸åœ¨äºå†™å‡ºä¸€ä¸ª â€œå®Œç¾åœ°æ”¯æŒå¼‚æ­¥ç­‰å„ç§å‡½æ•°çš„ä»»ä½•åœºæ™¯ä¸‹çš„æŸ¯é‡ŒåŒ–æ“ä½œâ€<br>æ›´å¤šçš„æ˜¯äº†è§£å‡½æ•°, é—­åŒ…, æŸ¯é‡ŒåŒ–, å…ƒç¼–ç¨‹, è¿‡ç¨‹å®çš„æ¦‚å¿µ, å±äºé¢å‘æ–°æ‰‹å°½é‡åšåˆ°å‹å¥½çš„æ‚ä¸ƒæ‚å…«æ•™ç¨‹, è¯·å¤šåŒ…å®¹å•¦QAQ<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="cheng-pin-yan-shi"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#cheng-pin-yan-shi">æˆå“æ¼”ç¤º</a></h1>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// tests/test.rs
use curried::{curry, to_curry};
use std::fmt::Display;

#[curry]
fn add(a: i32, b: i32, c: i32) -> i32 {
    a + b + c
}

#[curry]
fn concat_string&lt;T>(a: T, b: T, c: T) -> String
where
    T: Display + 'static, // Note: You should additionally add 'static
{
    a.to_string() + &amp;b.to_string() + &amp;c.to_string()
}

fn map(a: i32, b: i32, c: i32) -> i32 {
    a + b - c
}

fn normal_curry() {
    let i = add(1)(2)(3);
    assert_eq!(i, 6);
}

fn generic_curry() {
    let f = concat_string(1)(23);
    let s = f(456);
    assert_eq!(s, "123456");
}

fn map_curry() {
    let f = to_curry!(map(a, b, c));
    let i = [1, 2, 3].map(f(1)(2));
    assert_eq!(i, [4, 5, 6]);
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å½“ä½ çœ‹å®Œæœ¬èŠ‚, å°±èƒ½å¤Ÿè·å¾—ä¸€ç§åŸºäºè¿‡ç¨‹å®å®ç°çš„è¯­æ³•ç³–<br>(æˆå“åŸºäº stable-rust, ä¸è¿‡ä¸­é—´å­¦ä¹ çš„æ—¶å€™ä¼šæ¼”ç¤º nightly-rust ä¸‹çš„ä¸€äº› feature)<br><br>ç®€å•æ¥è¯´, æŸ¯é‡ŒåŒ–(curry) è®©æˆ‘ä»¬å°†ä¸€ä¸ª â€œæ¥æ”¶nä¸ªå‚æ•°çš„nå…ƒå‡½æ•°â€, è½¬åŒ–ä¸ºä¸€ä¸ª â€œæ¥æ”¶1ä¸ªå‚æ•°å¹¶è¿”å›ä¸€ä¸ª(n-1)å…ƒå‡½æ•°çš„å‡½æ•°â€<br>äºæ˜¯ add(1, 2, 3) å¯ä»¥è¢«å†™ä½œ add(1)(2)(3), ä¹‹åä¼šå†è®²è§£æŸ¯é‡ŒåŒ–ç›¸å…³çš„ä¸€äº›ä½œç”¨<br><br>æ­£ç‰‡å¼€å§‹å’¯!<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="han-shu"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#han-shu">å‡½æ•°</a></h1>
      <p>ä¸ºäº†æ–¹ä¾¿ä¹‹åå®ç°æŸ¯é‡ŒåŒ–æ—¶çš„è®²è§£, æ‰€ä»¥å…ˆæå‰å°†ä¸€äº›æ¦‚å¿µæ”¾åœ¨äº†å‰é¢, é¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹å‡½æ•°<br></p>
      <h2 class="flex items-center w-fit my-6" id="han-shu-xiang-yu-zhi-zhen"><span class="text-2xl m-2 text-cyan-500">></span> <a class="text-2xl hover:underline underline-offset-8" href="#han-shu-xiang-yu-zhi-zhen">å‡½æ•°é¡¹ä¸æŒ‡é’ˆ</a></h2>
      <p>ä»€ä¹ˆæ˜¯å‡½æ•°? ä¼ å…¥å‚æ•°, è¿›è¡Œæ“ä½œ, ç„¶åè¿”å›ç»“æœ, ä»…æ­¤è€Œå·² (ç»“æœå¯ä»¥ä¸ºç©º)<br>åœ¨ rust ä¸­, ä¸‹é¢è¿™ç§ <code class="font-semibold text-[#aa8bd5]"><code>fn</code></code> å¼€å¤´çš„ <code class="font-semibold text-[#aa8bd5]"><code>item</code></code> æ˜¯æœ€å¸¸è§çš„, ä¹Ÿå«ä½œ <a class="underline underline-offset-5 font-medium" href="https://doc.rust-lang.org/reference/types/function-item.html">function-item</a><br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn foo(x: i32) -> i32 {
    x + 1
}

fn main() {
    let a: fn(i32) -> i32 = foo;

    // è¾“å‡ºç»“æœæ˜¯ä¸ªç±»ä¼¼è¿™æ ·çš„æŒ‡é’ˆçš„åœ°å€: 0x600cc581a4f0 
    println!("{:p}", a);
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­, <code class="font-semibold text-[#aa8bd5]"><code>fn foo</code></code> ä¸ <code class="font-semibold text-[#aa8bd5]"><code>fn main</code></code> éƒ½æ˜¯ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>item(é¡¹)</code></code>, è€Œå˜é‡ a çš„ç±»å‹æ˜¯ <em>å‡½æ•°æŒ‡é’ˆç±»å‹(function pointer type)</em><br></p>
      <h2 class="flex items-center w-fit my-6" id="you-shi-and-que-xian"><span class="text-2xl m-2 text-cyan-500">></span> <a class="text-2xl hover:underline underline-offset-8" href="#you-shi-and-que-xian">ä¼˜åŠ¿ and ç¼ºé™·</a></h2>
      <p>å¯¹äºæœ‰æ³›å‹çš„å‡½æ•°, å…¶æœ¬èº«ä¹Ÿæœ‰ä¸€ä¸ªç±»å‹, å› ä¸ºrustçš„æ³›å‹æ˜¯ <em>å¼‚æ„ç¿»è¯‘(heterogeneous-translation)</em><br>å³ rust åœ¨ç¼–è¯‘æ—¶ä¼šå•æ€åŒ–æ¯ä¸ªæ³›å‹å‡½æ•°, å³ä¸ºå…¶ç”Ÿæˆå…·ä½“ç±»å‹<br><br>å¯¹äºæ³›å‹å‡½æ•°, æˆ‘ä»¬è¦æ‰‹åŠ¨æŒ‡å®šç±»å‹, å¸®åŠ©ç¼–è¯‘å™¨è¿›è¡Œæ¨å¯¼:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn bar&lt;T>(x: T) -> T {
    x
}

fn foo(x: i32) -> i32 {
    x + 1
}

fn main() {
    let mut b: fn(i32) -> i32 = bar::&lt;i32>;
    b = foo;
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>ä½ ä¼šæ³¨æ„åˆ°æˆ‘ä»¬æ‰‹åŠ¨æ ‡æ³¨äº†å˜é‡çš„ç±»å‹, å¹¶ä¸”å…¶å¯ä»¥è¢«èµ‹å€¼ä¸€ä¸ªç±»å‹ç›¸åŒçš„å‡½æ•°<br>ä½†è‹¥æ˜¯è‡ªåŠ¨æ¨å¯¼, åœ¨IDE/ç¼–è¾‘å™¨ä¸Šæ‚¬æµ®çš„ç±»å‹ä¼šå¤šä¸€ä¸ª <em>æ ‡è¯†ç¬¦(ident)</em>, ä¹Ÿå°±æ˜¯å‡½æ•°æœ¬èº«çš„åå­—(æ— æ³•æ‰‹åŠ¨æ ‡æ³¨)<br>å€˜è‹¥å°è¯•è®©ç¼–è¯‘å™¨è‡ªè¡Œæ¨å¯¼:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn foo(x: i32) -> i32 {
    x + 1
}

fn bar(x: i32) -> i32 {
    x + 1
}

fn main() {
    // typeof(a): fn foo(i32) -> i32
    let mut a = foo;
    a = bar;  // Failed to compile: type mismatched
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å› ä¸ºç¼–è¯‘å™¨å…¶å®ä¸ºæ¯ä¸ªå‡½æ•°éƒ½ç”Ÿæˆäº†ä¸€ä¸ª <em>ç‹¬ä¸€æ— äºŒçš„æ ‡è¯†ç¬¦(unique identifier)</em>, å¹¶å°†å…¶ä½œä¸ºç±»å‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†<br>å¦‚æœæˆ‘ä»¬ä¸æ˜¯è‡ªå·±æ‰‹åŠ¨æ ‡æ³¨ç±»å‹, è€Œæ˜¯ä»»ç”±ç¼–è¯‘å™¨å°†è¿™é»˜è®¤çš„æ ‡è¯†ç¬¦æ·»åŠ ä¸Šå», å°±ä¼šå¯¼è‡´ <em>type mismatched</em> çš„ç¼–è¯‘æœŸé”™è¯¯<br><br>rust ä¸­çš„å‡½æ•°è¿˜æ˜¯æ‰€è°“çš„ <em>ZST(zero sized type)</em>, å³ <em>é›¶å¤§å°ç±»å‹</em>, å› ä¸ºå…¶ç±»å‹éƒ½æ˜¯åœ¨ç¼–è¯‘æœŸé—´å°±å·²ç»ç¡®å®š, å…¨æ˜¯é™æ€çš„<br><br>åœ¨ rust-reference ä¸­çš„ <a class="underline underline-offset-5 font-medium" href="https://doc.rust-lang.org/reference/types/function-item.html">function-item</a> ä¸­, æ˜ç¡®æè¿‡ç¼–è¯‘å™¨å¯¹äºè¿™äº›fnç±»å‹éƒ½è‡ªåŠ¨å®ç°äº†å“ªäº› trait:<br><code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code>, <code class="font-semibold text-[#aa8bd5]"><code>FnMut</code></code>, <code class="font-semibold text-[#aa8bd5]"><code>FnOnce</code></code>, <code class="font-semibold text-[#aa8bd5]"><code>Copy</code></code>, <code class="font-semibold text-[#aa8bd5]"><code>Clone</code></code>, <code class="font-semibold text-[#aa8bd5]"><code>Send</code></code>, <code class="font-semibold text-[#aa8bd5]"><code>Sync</code></code> (å‰ä¸‰ä¸ª trait å¯¹åº”é—­åŒ…, æˆ‘ä»¬é©¬ä¸Šå°±è¦è®²åˆ°)<br><br><strong>ä½†æ˜¯, ä½†æ˜¯å•Š, ä½†æ˜¯! è¿™äº›ç±»å‹æœ‰ä¸€ä¸ªè‡´å‘½çš„ç¼ºé™·, é‚£å°±æ˜¯æ²¡æœ‰åŠæ³•ä½¿ç”¨ outer ç¯å¢ƒä¸‹çš„å˜é‡</strong><br>(å¥½å§å¤¸å¼ äº†ç‚¹, å…¶å®è¿™ä¹Ÿä¸å«ç¼ºé™·, åªæ˜¯å•çº¯çš„åˆ†å·¥åˆä½œè€Œå·²)<br><br>ä¸¾ä¸ªä¾‹å­, å¦‚æœæˆ‘ä»¬æƒ³è¿™æ ·åšæ˜¯ä¸å¯ä»¥çš„, å› ä¸ºå¼•ç”¨çš„ä¸æ˜¯ const ä¹Ÿä¸æ˜¯ static, è€Œæ˜¯ç”¨ let ä¿®é¥°çš„å±€éƒ¨å˜é‡:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn main() {
    let a = 1;
    fn print_a() {
        println!("{}", a);
    }
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>è¿™æ—¶å€™å°±è¦è®ºåˆ°æˆ‘ä»¬çš„é—­åŒ…ç±»å‹ç™»åœºäº†! é”µé”µé”µé”µ!(BGMèµ·!)<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="bi-bao"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#bi-bao">é—­åŒ…</a></h1>
      <p>è®©æˆ‘ä»¬å¼€å§‹è®²è§£ <em>é—­åŒ…(closure)</em> å§, è¿™æ˜¯æœ¬ç¯‡æ–‡ç« çš„é‡å¤´æˆä¹‹ä¸€<br></p>
      <h2 class="flex items-center w-fit my-6" id="bu-huo-zi-you-bian-liang"><span class="text-2xl m-2 text-cyan-500">></span> <a class="text-2xl hover:underline underline-offset-8" href="#bu-huo-zi-you-bian-liang">æ•è·è‡ªç”±å˜é‡</a></h2>
      <p>æœ€æ—©å®ç° <em>é—­åŒ…(closure)</em> çš„è¯­è¨€æ˜¯ <em>scheme</em>(lispçš„ä¸¤ç§ä¸»è¦æ–¹è¨€ä¹‹ä¸€), å…¶å®šä¹‰éå¸¸ç®€å•: èƒ½å¤Ÿæ•è·ä¸ä½¿ç”¨<em>è‡ªç”±å˜é‡</em>çš„å‡½æ•°<br>åœ¨ rust ä¸­, é—­åŒ…ä¼˜äºå‡½æ•°é¡¹çš„å…¨éƒ¨çš„ç”¨å¤„ä¸æ¦‚å¿µ, éƒ½å›´ç»•ç€ <strong>æ•è·è‡ªç”±å˜é‡</strong> è€Œå±•å¼€<br></p>
      <p>ä»€ä¹ˆæ˜¯ <em>è‡ªç”±å˜é‡</em>? å…¶å®ä½ åœ¨ä¸Šä¸€èŠ‚çš„æœ«å°¾å·²ç»è§è¯†è¿‡äº†, è®©æˆ‘ä»¬å†æŠŠé‚£éƒ¨åˆ†çš„ä»£ç è´´å‡ºæ¥:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn main() {
    let a = 1;
    fn print_a() {
        println!("{}", a);
    }
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>è®©æˆ‘ä»¬å¿½ç•¥å…ˆå‰çš„ç¼–è¯‘é”™è¯¯, å¹¶ä¸”å‡è®¾è¿™éƒ¨åˆ†ä»£ç èƒ½æˆåŠŸç¼–è¯‘:<br><br>åœ¨å¤–å±‚å‡½æ•° <strong>main</strong> ä¸­, æˆ‘ä»¬å®šä¹‰äº† <strong>a</strong>, å®ƒæ˜¯åœ¨ <strong>main</strong> å‡½æ•°ä¸­äº§ç”Ÿçš„, å®ƒçš„ä¸€åˆ‡éƒ½è¢«å…¶æ‰€çŸ¥æ™“, æ‰€ä»¥å¯¹è¯¥å¤–å±‚å‡½æ•°æ¥è®², a æ˜¯ <em>bounded</em>(ä¸è‡ªç”±/è¢«çº¦æŸ) çš„<br>ä½†å¯¹äºå†…å±‚çš„å‡½æ•° <strong>print_a</strong> æ¥è®², å˜é‡ <strong>a</strong> å³æ²¡æœ‰å‡ºç°åœ¨å‚æ•°çš„ä½ç½®, ä¹Ÿä¸æ˜¯åœ¨å…¶å‡½æ•°ä½“å†…äº§ç”Ÿçš„, æ‰€ä»¥å¯¹äºå†…å±‚å‡½æ•°æ¥è®², a æ˜¯ <em>free</em>(è‡ªç”±) çš„<br><br>å€˜è‹¥é—­åŒ…æ˜¯ <em>èƒ½å¤Ÿæ•è·ä¸ä½¿ç”¨è‡ªç”±å˜é‡çš„å‡½æ•°</em>, é‚£ä¹ˆè¿™é‡Œçš„ <strong>print_a</strong> æ¯«æ— ç–‘é—®å°±æ˜¯ä¸€ä¸ªé—­åŒ…<br>å½“ç„¶, åœ¨å¾ˆå¤šç¼–ç¨‹è¯­è¨€ä¸­, é—­åŒ…ä¸€èˆ¬ä¹Ÿæ‹¥æœ‰è®¸è®¸å¤šå¤šçš„åˆ«å, æ¯”å¦‚ <em>åŒ¿åå‡½æ•°/lambdaè¡¨è¾¾å¼</em> ç­‰ (è™½ç„¶å®Œå…¨è§†ä½œç›¸åŒæ¦‚å¿µå¹¶ä¸ä¸¥è°¨, ä½†æš‚æ—¶å¿½ç•¥è¿™äº›åŒºåˆ«)<br><br>åœ¨ rust ä¸­, æˆ‘ä»¬å¯ä»¥è¿™æ ·åˆ›å»ºä¸ä½¿ç”¨é—­åŒ…, å…¶å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥è‡ªåŠ¨æ¨å¯¼ä¼ å…¥å‚æ•°çš„ç±»å‹:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">let f = || 1;
f()  // 1

let g = |x| x + 1;
g(1)  // 2

let a = 10;
let h = |x| a + x
h(10) // 20</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>é—­åŒ…ç›¸å½“æœ‰ç”¨, è¿ç”¨åœºæ™¯å¾ˆå¤š, å€˜è‹¥æ²¡æœ‰é—­åŒ…, æˆ‘ä»¬å°±å¾—æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå…·ä½“åå­—çš„å‡½æ•°, å¹¶æ˜¾å¼å†™å‡ºå‡½æ•°ç­¾åä¸­çš„æ‰€æœ‰ç±»å‹<br>å¯¹äºå¯èƒ½åªæœ‰ä¸€ä¸¤è¡Œ, å¹¶ä¸”ä¸åœ¨ä¹åå­—çš„å‡½æ•°, æˆ‘ä»¬ä¸å¦‚å¹²è„†å†™æˆé—­åŒ…:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn main() {
    let (a, b, c) = ("a", "b", "c");
    let f = |x| (String::from("Hello, ") + x + "~~~~~~~~");

    f(a);
    f(b);
    f(c);
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™è¯¸å¦‚ map è¿™ç§å‡½æ•°ä¼ å…¥ä¸€ä¸ªé—­åŒ…, è¿™ä¹Ÿå«ä½œ å›è°ƒå‡½æ•°(callback), è¡¨ç¤ºå°†å…¶äº¤ç»™åˆ«äººæ¥è°ƒç”¨<br>åœ¨ä¸‹é¢çš„ä»£ç ä¸­, æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªé—­åŒ…äº¤ç»™äº† map, è€Œ map åˆ™ä¼šè°ƒç”¨ç”¨æˆ·ä¼ å…¥çš„é—­åŒ…<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// [10, 20, 30]
[1, 2, 3].map(|x| x * 10);</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­, æˆ‘ä»¬ä»…æŠŠé—­åŒ…å½“ä½œåŒ¿åå‡½æ•°ä½¿ç”¨, å¹¶æœªç”¨å®ƒæ•è· è‡ªç”±å˜é‡(æˆ–è€…è¯´ä½œç”¨åŸŸå†…çš„å±€éƒ¨å˜é‡) çš„èƒ½åŠ›<br>ä¹‹å‰çš„ function-item ä¸ä¼šä¹Ÿä¸èƒ½æ•è·ä½œç”¨åŸŸå†…å˜é‡, è€Œé—­åŒ…å¯ä»¥, è®©æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹ä¸é—­åŒ…ç±»å‹ç›¸å…³çš„æ ¸å¿ƒæ¦‚å¿µå§<br></p>
      <h2 class="flex items-center w-fit my-6" id="traitde-shi-xian"><span class="text-2xl m-2 text-cyan-500">></span> <a class="text-2xl hover:underline underline-offset-8" href="#traitde-shi-xian">traitçš„å®ç°</a></h2>
      <p>ä»¥ä¸‹ä¸‰ç§ trait å…ˆå‰å·²ç»æåˆ°è¿‡, æ‰€æœ‰ <em>function-item</em> éƒ½å·²è‡ªåŠ¨å®ç°äº†ä»–ä»¬, ä½†æ˜¯é—­åŒ…åˆ™å¹¶ä¸ä¼šå…¨éƒ¨éƒ½å®ç°<br>è¿™ä¸‰ä¸ª trait æœ‰æ‰€è°“çš„çˆ¶å­å…³ç³»: <code class="font-semibold text-[#aa8bd5]"><code>Fn: FnMut: FnOnce</code></code>, ä»£è¡¨å®ç° <code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code> çš„å‰ææ˜¯å®ç°äº† <code class="font-semibold text-[#aa8bd5]"><code>FnMut</code></code> ä¸ <code class="font-semibold text-[#aa8bd5]"><code>FnOnce</code></code>, å¯¹äº <code class="font-semibold text-[#aa8bd5]"><code>FnMut</code></code> åŒç†<br><br>è®©æˆ‘ä»¬å‡è®¾å­˜åœ¨ä¸€ä¸ªè‡ªç”±å˜é‡x, æ˜¯æŸä¸ªé—­åŒ…å”¯ä¸€æ‰€æ•è·çš„å˜é‡<br><br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>FnOnce</code></code>:<br></li>
      </ul>
      <p>è¡¨ç¤ºè‡³å°‘è¿è¡Œä¸€æ¬¡çš„é—­åŒ…, ä¸º <em>æ¯ä¸ªé—­åŒ…</em> è‡ªåŠ¨å®ç°<br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>FnMut</code></code>:<br></li>
      </ul>
      <p>è¡¨ç¤ºä»¥ <em>&amp;mut(å¯å˜å€Ÿç”¨)</em> çš„å½¢å¼ä½¿ç”¨äº†å˜é‡xçš„é—­åŒ…, ä¸º <em>ä¸ä¼šæ¶ˆè´¹è¢«æ•è·å˜é‡æ‰€æœ‰æƒçš„é—­åŒ…</em> è‡ªåŠ¨å®ç°<br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code>:<br></li>
      </ul>
      <p>è¡¨ç¤ºä»¥ <em>&amp;(ä¸å¯å˜å€Ÿç”¨)</em> çš„å½¢å¼ä½¿ç”¨äº†å˜é‡x(æˆ–è€…ä¸æ•è·å˜é‡x)çš„é—­åŒ…, ä¸º <em>ä¸ä¼šæ¶ˆè´¹xæ‰€æœ‰æƒä¹Ÿä¸ä¼šæ”¹å˜(mutate)xçš„å€¼çš„é—­åŒ…</em> è‡ªåŠ¨å®ç°<br><br>å½“ä½ åˆ›å»ºé—­åŒ…æ—¶, ä¼šè‡ªåŠ¨ä¸ºé—­åŒ…é€‰æ‹©æ€§åœ°å®ç°å®ƒä»¬<br>æ¯ä¸ªé—­åŒ…éƒ½è‡ªåŠ¨å®ç°äº† <code class="font-semibold text-[#aa8bd5]"><code>FnOnce</code></code>, è¡¨ç¤ºè‡³å°‘èƒ½è¿è¡Œä¸€æ¬¡, æ¯ä¸ªé—­åŒ…é™¤æ­¤ä¹‹å¤–è¿˜ä¼šè‡ªåŠ¨å®ç° <code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code> æˆ–è€… <code class="font-semibold text-[#aa8bd5]"><code>FnMut</code></code> (å–å†³äºä½ ä»¥ä»€ä¹ˆå½¢å¼ä½¿ç”¨è¢«æ•è·çš„å˜é‡)<br><br>å€˜è‹¥é—­åŒ…å³æœªä»¥ <em>&amp;mutçš„å½¢å¼</em> ä½¿ç”¨å˜é‡x(æœªå®ç° <code class="font-semibold text-[#aa8bd5]"><code>FnMut</code></code>), ä¹Ÿä¸æ˜¯ä»¥ <em>&amp;çš„å½¢å¼</em> ä½¿ç”¨å˜é‡x/æ²¡æœ‰æ•è·å˜é‡x(æœªå®ç°<code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code>), é‚£ä¹ˆå®ƒè‡ªç„¶åªå®ç°äº† <code class="font-semibold text-[#aa8bd5]"><code>FnOnce</code></code><br>è¿™æ ·ä¸€æ¥, åªå®ç° <code class="font-semibold text-[#aa8bd5]"><code>FnOnce</code></code> çš„é—­åŒ…, ç†æ‰€å½“ç„¶åœ°ä»£è¡¨ç€ä¼šä»¥ <em>å–å¾—æ‰€æœ‰æƒçš„å½¢å¼</em> ä½¿ç”¨è¢«æ•è·çš„å˜é‡ (æ¯•ç«Ÿå°±è¿™ä¸‰ç§å½¢å¼)<br><br>å®ƒä»¬ä¹‹é—´å­˜åœ¨çˆ¶å­å…³ç³» <code class="font-semibold text-[#aa8bd5]"><code>Fn: FnMut: FnOnce</code></code>, ä»£è¡¨ <code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code> æ˜¯åè€…çš„ <em>sub-trait(å­trait)</em>, å®ç° <code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code> å¿…é¡»å…ˆå®ç° <code class="font-semibold text-[#aa8bd5]"><code>FnMut/FnOnce</code></code><br>å› æ­¤å¯¹äºåªè¦æ±‚ä¼ å…¥ <code class="font-semibold text-[#aa8bd5]"><code>FnOnce</code></code> çš„åœ°æ–¹, è‡ªç„¶å¯ä»¥è¢«å…¶ <code class="font-semibold text-[#aa8bd5]"><code>sub-trait</code></code> ä»¬æ‰€ä»£æ›¿ (å­traitåŸºäºçˆ¶traitçš„åŸºç¡€ä¸Šå¤šå®ç°äº†ä¸€äº›ä¸œè¥¿)<br><br>å€˜è‹¥å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸ªé—­åŒ…, é‚£ä¹ˆåº”ä¼˜å…ˆè¿”å› <code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code> (æ ¹æ®å…ˆå‰é˜è¿°è¿‡çš„ sub-trait çš„äº‹å®å¯çŸ¥ <code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code> æ›´åŠ é€šç”¨)<br><br>è‹¥é—­åŒ…æ•è·äº† <code class="font-semibold text-[#aa8bd5]"><code>i32/f64/bool</code></code> ç­‰åŸºç¡€ç±»å‹æ—¶, çœ‹èµ·æ¥å°±å¥½åƒå®ƒä»¬çš„æ‰€æœ‰æƒè¢«æ‹¿èµ°äº†, ä½†è¯·åˆ«å¿˜è®° <code class="font-semibold text-[#aa8bd5]"><code>Copy</code></code> çš„å­˜åœ¨<br>å½“è¢«æ•è·å˜é‡æ˜¯ä¸ªå®ç°äº† <code class="font-semibold text-[#aa8bd5]"><code>Copy</code></code> çš„ç±»å‹, é—­åŒ…ä¼šæ‹¿èµ°å…¶å‰¯æœ¬, è¿™å¹¶æœª æ¶ˆè´¹è¢«æ•è·å˜é‡çš„æ‰€æœ‰æƒ<br></p>
      <h2 class="flex items-center w-fit my-6" id="ni-ming-lei-xing-sheng-cheng"><span class="text-2xl m-2 text-cyan-500">></span> <a class="text-2xl hover:underline underline-offset-8" href="#ni-ming-lei-xing-sheng-cheng">åŒ¿åç±»å‹ç”Ÿæˆ</a></h2>
      <p>ç”Ÿæˆé—­åŒ…æ—¶, ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åˆ›å»ºåŒ¿åçš„ç»“æ„ä½“, å¹¶ä¸ºè¯¥ç±»å‹å®ç° <code class="font-semibold text-[#aa8bd5]"><code>Fn/FnMut/FnOnce</code></code> ç­‰ trait, æˆ‘ä»¬å¹¶ä¸çŸ¥é“å…¶å…·ä½“ç±»å‹å«ä»€ä¹ˆ<br>å› æ­¤, æˆ‘ä»¬å¾—ç”¨æ³›å‹æˆ– impl å…³é”®å­—æ¥è¡¨ç¤ºé—­åŒ…çš„å®é™…ç±»å‹:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn generate_close() -> impl Fn(i32) -> i32 {
    |x| x + 1
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>è¿™ä¹Ÿå«ä½œ <em>opaque-type(ä¸é€æ˜ç±»å‹)</em>, å¯¹äºç¼–è¯‘å™¨æ¥è®², å®ƒåªçŸ¥é“è¿™ä¸ªè¿”å›å€¼çš„ç±»å‹å®ç°äº†æŸä¸ª trait, é™¤æ­¤ä»¥å¤–ä¸€æ— æ‰€çŸ¥<br><br>è¿™ç±»ä¼¼å…ˆå‰æ‰€è¿°çš„ <em>function-item</em> é‡Œçš„ <em>unique identifier</em>, æ¯ä¸ªå…·ä½“çš„é—­åŒ…å®ä¾‹æ˜¯ç”Ÿæˆçš„åŒ¿åç»“æ„ä½“çš„å…·ä½“å®ä¾‹<br>å¯¹äº <code class="font-semibold text-[#aa8bd5]"><code>impl Fn</code></code> è¿™ç§ <em>opaque-type</em>, å³ä½¿çœ‹èµ·æ¥ç±»å‹ä¸€æ ·, å…¶å®å®é™…ç±»å‹å¹¶ä¸ä¸€æ ·<br><br>ä¸è¿‡ <em>éæ•è·é—­åŒ…non-capturing closure)</em> é™¤å¤–, å¦‚æœé—­åŒ…ä¸æ•è·å˜é‡, åˆ™å®Œå…¨ç­‰ä»·äº <code class="font-semibold text-[#aa8bd5]"><code>fn</code></code> å£°æ˜å¼€å¤´çš„ <em>function-item</em><br>å¯¹äºè¿™æ ·çš„é—­åŒ…, å¦‚æœå®ƒä»¬çœ‹èµ·æ¥ç±»å‹ä¸€æ ·, é‚£ä¹ˆå®ƒä»¬çš„ç±»å‹åˆ™æ˜¯çœŸçš„ä¸€æ ·çš„ (å¹¶ä¸”å¯ä»¥ä¸ <code class="font-semibold text-[#aa8bd5]"><code>fn</code></code> å¼€å¤´çš„ç±»å‹äº’ç›¸è½¬åŒ–)<br></p>
      <p>å°è¯•ç”¨ç¼–è¯‘é”™è¯¯è¿›è¡Œè¯æ˜:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// f1 ä¸æ•è·ä»»ä½•è‡ªç”±å˜é‡, ç›¸å½“äºç”¨ fn å£°æ˜äº†ä¸€ä¸ªå‡½æ•°å¹¶è¿”å›
fn f1() -> impl Fn() -> i32 {
    if true {
        || 1
    } else {
        || 2
    }
}

// f2 æ•è·äº†è‡ªç”±å˜é‡, å¹¶ä¸ç­‰ä»·äº fn å£°æ˜çš„å‡½æ•°
fn f2() -> impl Fn() -> i32 {
    let a = 1;
    if true {
        || a
    } else {
        || a
    }
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>è®©æˆ‘ä»¬è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ä»£ç :<br><br>æˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ªäº‹å®, é‚£å°±æ˜¯ rust ä¸­çš„ <code class="font-semibold text-[#aa8bd5]"><code>if-else/match</code></code> è¦æ±‚æ¯ä¸ªåˆ†æ”¯æ‰€è¿”å›çš„å€¼å¿…é¡»å…·æœ‰ç›¸åŒç±»å‹<br>è¿™æ®µä»£ç è¿›è¡Œç¼–è¯‘æ—¶, ç¬¬ä¸€ä¸ªä¸ä¼šæŠ¥é”™, ç¬¬äºŒä¸ªåˆ™æ— æ³•é€šè¿‡ç¼–è¯‘, è¯æ˜äº† <code class="font-semibold text-[#aa8bd5]"><code>f1</code></code> ä¸­ä¸¤ä¸ª <em>æœªæ•è·é—­åŒ…</em> å…·æœ‰ç›¸åŒç±»å‹<br>ä½†å¯¹äº <code class="font-semibold text-[#aa8bd5]"><code>f2</code></code> ä¸­çš„é—­åŒ…ä»¬, å› ä¸ºå®ƒä»¬ä¸¤ä¸ªæ•è·äº† <em>è‡ªç”±å˜é‡</em>, å› æ­¤å…·æœ‰ä¸åŒç±»å‹<br></p>
      <h2 class="flex items-center w-fit my-6" id="qiang-zhi-zhuan-yi-suo-you-quan"><span class="text-2xl m-2 text-cyan-500">></span> <a class="text-2xl hover:underline underline-offset-8" href="#qiang-zhi-zhuan-yi-suo-you-quan">å¼ºåˆ¶è½¬ç§»æ‰€æœ‰æƒ</a></h2>
      <p>å…ˆå‰ä¸ºæ¯ä¸ªé—­åŒ…è‡ªåŠ¨å®ç° trait æ—¶, å¼ºè°ƒçš„æ˜¯ <em>å¦‚ä½•ä½¿ç”¨</em>, ä½† <code class="font-semibold text-[#aa8bd5]"><code>move</code></code> å…³é”®å­—å¯å°†è¢«é—­åŒ…æ•è·çš„å˜é‡çš„æ‰€æœ‰æƒ, å¼ºåˆ¶äº¤ç»™é—­åŒ…(ä½†é—­åŒ…æœ¬èº«å¯ä»¥ä¸æ¶ˆè´¹æ‰€æœ‰æƒ)<br>è‹¥é—­åŒ…å†…ä»ç„¶åªæ˜¯ <em>ä»¥ä¸å¯å˜å€Ÿç”¨çš„å½¢å¼</em> å»ä½¿ç”¨è¢«æ•è·å˜é‡, é‚£ä¹ˆå®ƒä¾æ—§ä»ç„¶åªå®ç°äº† <code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code><br><br><code class="font-semibold text-[#aa8bd5]"><code>move</code></code> å…³é”®å­—, å¾ˆå¤šæ—¶å€™ç”¨äºè§£å†³ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜ (æˆ‘ä»¬åœ¨å®ç°æŸ¯é‡ŒåŒ–æ—¶, ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªç‰¹æ€§):<br>é—­åŒ…æ‰€æ•è·çš„å˜é‡, å…¶ç”Ÿå‘½å‘¨æœŸå¯èƒ½çŸ­äºé—­åŒ…æœ¬èº«, æ¯”å¦‚ä½ å£°æ˜ä¸€ä¸ªå‡½æ•°, è¿”å›å€¼æ˜¯ä¸ªé—­åŒ…, å®ƒæ•è·äº†å‡½æ•°ä½“å†…äº§ç”Ÿçš„å˜é‡<br>è¿™ä¸ªè¢«æ•è·çš„å˜é‡, ä¼šéšç€å‡½æ•°çš„æ‰§è¡Œåœ¨æœ«å°¾è¢« <code class="font-semibold text-[#aa8bd5]"><code>Drop</code></code> æ‰, å› æ­¤å½“å·²ä½œä¸ºè¿”å›å€¼ä¼ é€’ç»™å¤–ç•Œçš„é—­åŒ…æƒ³ä½¿ç”¨å®ƒæ—¶, å°±ä¼šè®¿é—®æ— æ•ˆçš„å˜é‡<br>å› æ­¤, æˆ‘ä»¬ç›´æ¥ç”¨ <code class="font-semibold text-[#aa8bd5]"><code>move</code></code> å°†è¯¥å˜é‡çš„æ‰€æœ‰æƒå¼ºåˆ¶ä¼ é€’ç»™é—­åŒ…å³å¯, å³ä½¿é—­åŒ…æœ¬èº«å¯èƒ½å¹¶ä¸éœ€è¦æ¶ˆè´¹å…¶æ‰€æœ‰æƒ<br><br>å“Ÿè¥¿, å¤§è‡´çš„åŸºç¡€æ¦‚å¿µéƒ½ä¼šäº†<br>æ—¢ç„¶ä½ å·²ç»æ‡‚å¾—äº† <code class="font-semibold text-[#aa8bd5]"><code>1+1=2</code></code> äº†, è®©æˆ‘ä»¬å¼€å§‹è¯æ˜å“¥å¾·å·´èµ«çŒœæƒ³å§!<br>æ—¢ç„¶ä½ å·²ç»æ‡‚å¾—å‡½æ•°ä¸é—­åŒ…çš„æ¦‚å¿µäº†, è®©æˆ‘ä»¬å¼€å§‹ç”¨è¿‡ç¨‹å®è¿›è¡Œå…ƒç¼–ç¨‹, å†™ä¸€ä¸ªå¯ä»¥å°†å‡½æ•°æŸ¯é‡ŒåŒ–çš„å±æ€§å®å§!<br>æ—¢ç„¶ä½ å·²ç»æ‡‚å¾—å‡½æ•°ä¸é—­åŒ…çš„æ¦‚å¿µäº†, è®©æˆ‘ä»¬å¼€å§‹æ‰‹åŠ¨æ¨¡æ‹Ÿä¸€ä¸‹æŸ¯é‡ŒåŒ–å§!<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="ke-li-hua"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#ke-li-hua">æŸ¯é‡ŒåŒ–</a></h1>
      <p><em>æŸ¯é‡ŒåŒ–(curry)</em>, æŒ‡ä»…æ¥æ”¶ä¸€ä¸ªå‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ–°å‡½æ•°, è¿™ä¸ªå‡½æ•°ä¹Ÿä»…æ¥æ”¶ä¸€ä¸ªå‚æ•°å¹¶è¿”å›æ–°å‡½æ•°â€¦<br>ç›´åˆ°æœ€åä¸€ä¸ªå‡½æ•°, æ¥æ”¶ä¸€ä¸ªå‚æ•°å¹¶è¿”å›æœ€åçš„å€¼<br></p>
      <p>æŸ¯é‡ŒåŒ–çš„æ¦‚å¿µå…¶å®ç›¸å½“ç®€æ´å¥½æ‡‚, éš¾çš„æ˜¯åœ¨é»˜è®¤ä¸æ”¯æŒæŸ¯é‡ŒåŒ–çš„è¯­è¨€ä¸­å®ç°æŸ¯é‡ŒåŒ–(æ²¡é”™, å°±æ˜¯ä½ , rust!)<br>è¯·è€ƒè™‘åˆ©ç”¨å…ˆå‰æåˆ°çš„çŸ¥è¯†, å°è¯•å¯¹ä¸‹é¢è¿™ä¸ªç®€å•çš„å‡½æ•°è¿›è¡ŒæŸ¯é‡ŒåŒ–:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn add(a: i32, b: i32, c: i32) -> i32 {
    a + b + c
}

fn add_curry(a: i32) -> ??? {
    ???
}

fn main() {
    add(1, 2, 3)        // 6
    add_curry(1)(2)(3)  // 6
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æ€è·¯å¾ˆå®¹æ˜“æƒ³åˆ°, æ¯•ç«Ÿè¯¥æ€ä¹ˆåšä¸éƒ½å·²ç»å‘Šè¯‰ä½ äº†å— (bushi<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">#![feature(impl_trait_in_fn_trait_return)]

fn add(a: i32, b: i32, c: i32) -> i32 {
    a + b + c
}

fn add_curry(a: i32) -> impl FnOnce(i32) -> impl FnOnce(i32) -> i32 {
    move |b| move |c| a + b + c
}

fn main() {
    add(1, 2, 3)        // 6
    add_curry(1)(2)(3)  // 6
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å…ˆå‰åœ¨é—­åŒ…ç¯‡å·²ç»è®²è¿°è¿‡ä¸€äº›æ¦‚å¿µ:<br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>move</code></code> å…³é”®å­—å¼ºåˆ¶å–èµ°è¢«æ•è·å˜é‡çš„æ‰€æœ‰æƒ</li>
        <li>é—­åŒ…/åŒ¿åå‡½æ•° æœ¬èº«åˆ°åº•è‡ªåŠ¨å®ç°äº† <code class="font-semibold text-[#aa8bd5]"><code>Fn</code></code> è¿˜æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>FnMut</code></code>, ç”±é—­åŒ…æœ¬èº«ä»¥ <em>ä½•ç§å½¢å¼</em> ä½¿ç”¨ <em>è¢«æ•è·çš„è‡ªç”±å˜é‡</em> è€Œå†³å®š</li>
        <li><code class="font-semibold text-[#aa8bd5]"><code>Fn: FnMut: FnOnce</code></code>, å‰ä¸¤è€…æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>FnOnce</code></code> çš„ sub-trait, æ¯”å…¶å¤šå®ç°äº†ä¸€äº›ä¸œè¥¿, æ‰€ä»¥ <code class="font-semibold text-[#aa8bd5]"><code>impl FnOnce</code></code> å¯ä»¥æŒ‡ä»£æ‰€æœ‰ç±»å‹çš„é—­åŒ…</li>
      </ul>
      <p><br><em>æ³¨æ„</em>:<br>å°†å‡½æ•°çš„è¿”å›å€¼ç±»å‹å†™ä½œ impl FnOnce æ—¶å¯ä»¥è¿”å›ä»»æ„ç±»å‹çš„é—­åŒ…, ä½†å½“ä½ å°†å®ƒç”¨äºæ¯”å¦‚ map éœ€è¦ä¼ å…¥ FnMut æ—¶ä¼šç¼–è¯‘å¤±è´¥<br>å› ä¸ºç¼–è¯‘å™¨åªçŸ¥é“å®ƒå®ç°äº† FnOnce, å³ä½¿ä½ äººè„‘ç¼–è¯‘æ—¶è§‰å¾—æ²¡é—®é¢˜, ä½†ç¼–è¯‘å™¨æ ¹æ®å‡½æ•°ç­¾åç­‰æ¥æ£€æŸ¥æ—¶å¹¶ä¸è®¤åŒä½  (ä¸é€æ˜ç±»å‹(opaque-type))<br><br>æ¥ä¸‹æ¥è®©æˆ‘ä»¬å¼€å§‹è¿‡ç¨‹å®çš„æ¦‚å¿µå§, äº†è§£ä»€ä¹ˆæ˜¯å…ƒç¼–ç¨‹, rust è¿‡ç¨‹å®çš„å¼ºå¤§ä¹‹å¤„, éšåå°†ç±»ä¼¼è¿™æ ·çš„å‡½æ•°è‡ªåŠ¨æŸ¯é‡ŒåŒ–å§<br><br>å•Šå’§? è¿™ä¸€èŠ‚ç»“æŸçš„ä¹Ÿå¤ªå¿«äº†å§? ç¯‡å¹…å¥½çŸ­å•Š, å°±è·Ÿâ–ˆ(æ•°æ®åˆ é™¤)ä¸â–ˆâ–ˆ(æ•°æ®åˆ é™¤)ä¸€æ ·çŸ­ (?<br>(å½“ç„¶ä¸å¯èƒ½å•Šå°å‚»ç“œ!!) å…¶å®è¿˜æœ‰ä¸€äº›å‘, ä¸è¿‡æˆ‘ä»¬å°†å…¶æ”¾åˆ°åé¢å†è®², ç”¨å®å…ˆæ¥å®ç°ä¸€ä¸ªåˆç‰ˆçš„è¯­æ³•ç³–å†è¯´<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="guo-cheng-hong"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#guo-cheng-hong">è¿‡ç¨‹å®</a></h1>
      <p>å€˜è‹¥æ˜¯çœŸçš„ä¸€ç‚¹éƒ½æ²¡æ¥è§¦è¿‡ç›¸å…³æ¦‚å¿µ, ç†è§£ä¸‹é¢çš„å†…å®¹æ—¶å¯èƒ½ä¼šæ¯”è¾ƒåƒåŠ›, æ˜ç™½çš„äººç›´æ¥è·³è¿‡è¿™èŠ‚å³å¯<br>æˆ‘å¼ºçƒˆå»ºè®®å­¦ä¹  rust ä¸­çš„å®/å…ƒç¼–ç¨‹æ—¶, å…ˆå­¦ä¹ ä¸€ç‚¹ <em>å£°æ˜å®(declare-macro)</em>, å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥çœ‹ä¸‹é¢, ä¼šè®²çš„!<br><br>å…¶åœ¨æˆ‘çš„åšå®¢ä¸­ä¹Ÿæœ‰ç›¸åº”æ•™ç¨‹, æˆ–è€…å»çœ‹ <a class="underline underline-offset-5 font-medium" href="https://veykril.github.io/tlborm/">rustå°å®ä¹¦</a><br></p>
      <h2 class="flex items-center w-fit my-6" id="yuan-bian-cheng-de-jian-jie"><span class="text-2xl m-2 text-cyan-500">></span> <a class="text-2xl hover:underline underline-offset-8" href="#yuan-bian-cheng-de-jian-jie">å…ƒç¼–ç¨‹çš„ç®€ä»‹</a></h2>
      <p><em>å®(macro)</em> æ˜¯ rust ä¸­ä¸€ç§é‡è¦çš„ <em>å…ƒç¼–ç¨‹(meta-programming)</em> æ‰‹æ®µ<br>åœ¨æ­£å¸¸ç¼–ç¨‹æ—¶, æˆ‘ä»¬å°† <code class="font-semibold text-[#aa8bd5]"><code>i32/f64/String</code></code> ç­‰ç±»å‹è§†ä½œæ•°æ®, æ“æ§ä¸è®¡ç®—å®ƒä»¬ç”Ÿæˆæ–°çš„æ•°æ®, è€Œå…ƒç¼–ç¨‹åˆ™å°†ä»£ç è§†ä½œæ•°æ®è¿›è¡Œæ“æ§, å¹¶ç”Ÿæˆæ–°çš„ä»£ç <br><br>ä¸¾ä¸ªä¾‹å­, æˆ‘ä»¬æ‹¿æ¯”è¾ƒå¸¸è§çš„ <code class="font-semibold text-[#aa8bd5]"><code>vec!</code></code> å®æ¥è¯´æ˜ (ä»…ä»…ä¸ºäº†è¯´æ˜å®çš„æ¦‚å¿µ, æ‰€ä»¥ä¼šæœ‰å‡ºå…¥å¹¶åŒ–ç®€)<br>ä¸‹é¢æ˜¯å®æ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„ <code class="font-semibold text-[#aa8bd5]"><code>1, 2, 3</code></code> æ‰€ç”Ÿæˆçš„å®é™…ä»£ç (ç®€åŒ–äº†):<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// 1
let a = vec![1, 2, 3]

// 2
let a = {
    let mut v = Vec::new();
    v.push(1);
    v.push(2);
    v.push(3);
    v
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æºä»£ç å…¶å®åªæ˜¯ä¸€ä¸²æ–‡æœ¬(String), å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šå«ä¹‰, å¾—äº¤ç»™ç¼–è¯‘å™¨è§£æè¿™ä¸²æ–‡æœ¬æ‰èƒ½å¾—åˆ°å¯æ‰§è¡Œç¨‹åº(ç¼–è¯‘)<br>å°±åƒæ­£å¸¸ç¼–ç¨‹æ—¶å°†æ•°æ®åˆ’åˆ†ä¸º <code class="font-semibold text-[#aa8bd5]"><code>i32/f64/String/Vec</code></code> ç­‰ç±»å‹ä¸€æ ·, å…ƒç¼–ç¨‹ä¸­ä¹Ÿå¯¹ä»£ç è¿›è¡Œäº†åˆ†ç±», ä¸ºæ–‡æœ¬èµ‹äºˆäº†äººä¸ºçš„å«ä¹‰:<br><em>è¡¨è¾¾å¼(expr)</em>, <em>æ ‡è¯†ç¬¦(ident)</em>, <em>å˜é‡ç±»å‹(type)</em>, <em>å­—é¢é‡(literal)</em>, <em>æ¨¡å¼(pattern)</em> ç­‰â€¦<br><br>æˆ‘ä»¬å°†è¿™äº›è¢«äººä¸ºèµ‹äºˆäº†æ„ä¹‰çš„æ–‡æœ¬å«ä½œ <em>Token(ç¼–ç¨‹è¯­è¨€ä¸­çš„æœ€å°è¯­æ³•å•å…ƒ)</em><br>åœ¨ rust å®˜æ–¹å†…åµŒæä¾›çš„ proc-macro åº“ä¸­, æˆ‘ä»¬å°†å…¶å½’ç±»ä¸º <em>TokenTree</em><br></p>
      <blockquote class="border-l-4 border-solid border-gray-300 mx-1 my-3 px-4 opacity-60">A single token or a delimited sequence of token trees (e.g., [1, (), ..]).</blockquote>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">pub enum TokenTree {
    Group(Group),     // è¢«æ‹¬å·åŒ…è£¹èµ·æ¥(åŒ…æ‹¬æ‹¬å·æœ¬èº«)çš„å†…å®¹
    Ident(Ident),     // æ ‡è¯†ç¬¦, æ¯”å¦‚å˜é‡å, å‡½æ•°å
    Punct(Punct),     // æ ‡ç‚¹ç¬¦å·, æ¯”å¦‚é€—å·, åŠ å·ç­‰
    Literal(Literal), // å­—é¢é‡, æ¯”å¦‚ 'a', "s", 2, true ç­‰
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>è€Œé€šè¿‡æä¾›çš„ proc-macro è¿™ä¸ªç¼–è¯‘å™¨å†…ç½®çš„åº“, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿‡ç¨‹å®æ“æ§ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code><br>å…¶æ¦‚å¿µç›¸å½“äº <code class="font-semibold text-[#aa8bd5]"><code>Vec&lt;TokenTree></code></code>, ä½† <code class="font-semibold text-[#aa8bd5]"><code>Clone</code></code> çš„ä»£ä»·è¾ƒä½<br><br>æˆ‘ä»¬å…¶å®ç»å¸¸ä½¿ç”¨è¿‡ç¨‹å®<br>å®ä¸ºæˆ‘ä»¬ç”Ÿæˆå¹¶éšè—äº†è¿™äº›ä»£ç , æš´éœ²ç»™ç”¨æˆ·çš„æ¥å£å®›è‹¥é­”æ³•ä¸€èˆ¬, è¿™å³æ˜¯å…ƒç¼–ç¨‹é­…åŠ›çš„å†°å±±ä¸€è§’:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// 1
#[derive(Debug)]
struct A(i32);

// 2
struct A(i32);
impl std::fmt::Debug for A {
    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;'_>) -> std::fmt::Result {
        todo!()
    }
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <h2 class="flex items-center w-fit my-6" id="guo-cheng-hong-de-shi-yong"><span class="text-2xl m-2 text-cyan-500">></span> <a class="text-2xl hover:underline underline-offset-8" href="#guo-cheng-hong-de-shi-yong">è¿‡ç¨‹å®çš„ä½¿ç”¨</a></h2>
      <p>æœ¬èŠ‚æˆ‘ä»¬å°†å¼€å§‹å®ç°ä¸€ä¸ªæœ€å°åŒ–çš„æŸ¯é‡ŒåŒ–å®<br>ä¸ºäº†ç…§é¡¾ç¬¬ä¸€æ¬¡å­¦ä¹ è¿‡ç¨‹å®çš„åŒå­¦, æˆ‘ä¼šè´´ä¸€ä¸‹è¿‡ç¨‹å®çš„ä¸‰ç§åˆ†ç±»ä¸å®é™…å¼€å‘æ—¶çš„å¸¸ç”¨åº“<br><br></p>
      <ul class="list-disc ml-5">
        <li><em>è¿‡ç¨‹å®(procedural-macro)</em>, å³ <em>proc-macro</em>, åœ¨ rust ä¸­æœ‰ä»¥ä¸‹ä¸‰ç§ç±»å‹:<br></li>
        <li><em>å‡½æ•°å¼(function like)</em>: ç±»ä¼¼äºè°ƒç”¨å‡½æ•°, ä¸å£°æ˜å®ä½¿ç”¨èµ·æ¥çš„è¯­æ³•ä¸€è‡´, ç±»ä¼¼ <code class="font-semibold text-[#aa8bd5]"><code>vec![]</code></code><br></li>
        <li><em>æ´¾ç”Ÿå®(derive macro)</em>: ä½ ä½¿ç”¨çš„å“ªäº› <code class="font-semibold text-[#aa8bd5]"><code>#[derive(...)]</code></code> éƒ½å±äºè¿™ç±»èŒƒç•´<br></li>
        <li><em>å±æ€§å®(attribute macro)</em>: æˆ‘ä»¬æ¥ä¸‹æ¥è¦åˆ›å»ºçš„æŸ¯é‡ŒåŒ–å®å°±æ˜¯è¿™ä¸€ç±», <code class="font-semibold text-[#aa8bd5]"><code>#[CustomMacro(Attribute)]</code></code>, å…¶ä¸­çš„ <code class="font-semibold text-[#aa8bd5]"><code>Attr</code></code> å¯ä»¥ä¸å†™ç½®ç©º<br></li>
      </ul>
      <p><br>å…¶å®å§, ç¬¬ä¸‰ç±»å®çš„ç”Ÿæˆäº§ç‰©ä½ å·²ç»è§åˆ°è¿‡äº†:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">#![feature(impl_trait_in_fn_trait_return)]

fn add(a: i32, b: i32, c: i32) -> i32 {
    a + b + c
}

fn add_curry(a: i32) -> impl FnOnce(i32) -> impl FnOnce(i32) -> i32 {
    move |b| move |c| a + b + c
}

fn main() {
    add(1, 2, 3)        // 6
    add_curry(1)(2)(3)  // 6
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å¦‚æœæ”¹æˆç¬¬ä¸‰ç±»çš„å±æ€§å®, åˆ™ç”¨æˆ·å¯ä»¥å†™æˆè¿™æ ·, ä¸éœ€è¦å…³å¿ƒå®ç°çš„ç»†èŠ‚:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">#![feature(impl_trait_in_fn_trait_return)]

use curried::curry;

#[curry]
fn add(a: i32, b: i32, c: i32) -> i32 {
    a + b + c
}

fn main() {
    let a = add(1);  // impl Fn(i32) -> impl Fn(i32) -> i32
    let b = a(2);    // impl Fn(i32) -> i32
    let c = b(3);    // i32: 6
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æˆ‘ä»¬å°† <code class="font-semibold text-[#aa8bd5]"><code>fn add(...) -> i32 { ... }</code></code> ä½œä¸ºå‚æ•°å–‚ç»™äº† <code class="font-semibold text-[#aa8bd5]"><code>#[curry]</code></code> è¿™ä¸ªå®, å®åƒä¸‹ä¼ å…¥çš„ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code>, è¿›è¡Œä¸€ç•ªæ“ä½œåç”Ÿæˆäº†æ–°çš„ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code><br>è¿™ä¸ªæ–°çš„ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code> æ‰ä¼šè¢«ç¼–è¯‘å™¨æ‰€ç¼–è¯‘, è¿™é‡Œç”Ÿæˆçš„ç»“æœæ˜¯ä¸€ä¸ªå‡½æ•°, å…¶åå­—æ¥æºäºä¼ å…¥çš„å‚æ•°, ä¹Ÿå« <code class="font-semibold text-[#aa8bd5]"><code>add</code></code>, ä½†å‡½æ•°ç­¾åä¸å‡½æ•°ä½“éƒ½è¢«ä¿®æ”¹è¿‡äº†<br><br>è®©æˆ‘ä»¬å¼€å§‹å†™ç¬¬ä¸€ä¸ªè¿‡ç¨‹å®å§, é¦–å…ˆæ–°å»ºä¸€ä¸ª crate, è®©æˆ‘ä»¬å°†å…¶å‘½åä¸º curried, å¹¶ä¸”æ·»åŠ ä¾èµ–:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-text text-sm sm:text-base">cargo new --lib curried
cd curried
cargo add proc-macro2
cargo add quote
cargo add syn -F "full"</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>éšåè®°å¾—ä¿®æ”¹ Cargo.toml, ä½¿å…¶æ˜¯ä¸ª proc-macro ç±»å‹çš„ lib:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-toml text-sm sm:text-base"># Cargo.toml
[dependencies]
proc-macro2 = "1.0.78"
quote = "1.0.35"
syn = { version = "2.0.51", features = ["full"] }

[lib]
proc-macro = true</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æœ«å°¾çš„ <code class="font-semibold text-[#aa8bd5]"><code>proc-macro = true</code></code>, æ˜¯å› ä¸ºç›®å‰ rust åªå…è®¸è¢«è¿™æ ·å£°æ˜çš„ lib ç¼–å†™è¿‡ç¨‹å®, å¹¶ä¸”åªå…è®¸å‘å¤–å¯¼å‡ºè¿‡ç¨‹å®<br>è¢«å£°æ˜ä¸º <code class="font-semibold text-[#aa8bd5]"><code>proc-macro</code></code> çš„ lib åœ¨é»˜è®¤æƒ…å†µä¸‹èƒ½ç›´æ¥ use çš„, é™¤äº† <code class="font-semibold text-[#aa8bd5]"><code>std</code></code> è¿˜å°†å¤šä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>proc-macro</code></code> (å®˜æ–¹æä¾›çš„ç”¨æ¥è§£æä¸ç”Ÿæˆ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code>)<br><br>æ¥ä¸‹æ¥è¦ç†æ¸…æ¥šæ–°åŠ è¿›æ¥çš„ä¸‰ä¸ª crate ä¹‹é—´çš„å…³ç³», è¿™ä¸‰ä¸ªå…¨éƒ½ä¸æ˜¯å®˜æ–¹çš„, ä½†å´æ˜¯å¼€å‘è¿‡ç¨‹å®çš„äº‹å®æ ‡å‡†:<br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>proc-macro2</code></code>:<br></li>
      </ul>
      <p>å’Œå®˜æ–¹æä¾›å†…åµŒçš„ proc-macro åå­—å¾ˆåƒ, ä¸è¿‡å…¶å®æ˜¯ç¬¬ä¸‰æ–¹å†™çš„, ä½†ç¡®å®æ˜¯ä¸‹ä¸€ä»£, æ— è„‘ç”¨å°±è¡Œäº†<br>å…¶æä¾›äº†å¯ä»¥åœ¨ <code class="font-semibold text-[#aa8bd5]"><code>build.rs/main.rs</code></code>, è¿˜æœ‰å•å…ƒæµ‹è¯•ä¸­è§£æ/ç”Ÿæˆ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code> çš„èƒ½åŠ›, æ˜¯å¯¹å®˜æ–¹åº“çš„ä¸€å±‚åŒ…è£…<br><br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>syn</code></code>:<br></li>
      </ul>
      <p>åŸºäº proc-macro2, æä¾›äº†å°† <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code> è§£æä¸ºæ›´åŠ é«˜æŠ½è±¡çš„ç»“æ„ (äººä¸ºåœ°èµ‹äºˆæ›´æ˜æ˜¾çš„æ„ä¹‰)<br>æ¯”å¦‚ <em>æ³›å‹(T)</em>, <em>whereå­å¥(where T:)</em>, <em>å‡½æ•°é¡¹(fn)</em>, <em>å¯è§æ€§(pub, pub(crate))</em> ç­‰, æ›´åŠ æ–¹ä¾¿åœ°è¿›è¡Œè§£æ<br><br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>quote</code></code>:<br></li>
      </ul>
      <p>åŸºäº <code class="font-semibold text-[#aa8bd5]"><code>proc-macro2</code></code>, æä¾›äº†æ ¹æ®ç”± <code class="font-semibold text-[#aa8bd5]"><code>syn/proc-macro2</code></code> å¾—åˆ°çš„è§£æç»“æ„, ä¾¿æ·åœ°ç”Ÿæˆæ–°çš„ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code> çš„æ–¹æ³•<br>å®ƒä¼šç»™ä½ ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>quote!</code></code> å®, æ–¹ä¾¿åœ°è¿›è¡Œæ’å€¼, ç”Ÿæˆæ–°çš„ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code><br><br>è€Œå®˜æ–¹å†…åµŒæä¾›çš„ <code class="font-semibold text-[#aa8bd5]"><code>proc-macro</code></code>, ä½ å¯ä»¥ç†è§£ä¸ºæŸç§ abi æ ‡å‡†, ç¼–è¯‘å™¨åªèƒ½é€šè¿‡ <code class="font-semibold text-[#aa8bd5]"><code>proc_macro::TokenStream</code></code> ç”Ÿæˆä»£ç <br>ç«™åœ¨ <code class="font-semibold text-[#aa8bd5]"><code>proc-macro2/syn/quote</code></code> æä¾›çš„é«˜æŠ½è±¡æ¡†æ¶ä¸Š, ç”Ÿæˆçš„åˆ™æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>proc_macro2::TokenStream</code></code>, è€Œé <code class="font-semibold text-[#aa8bd5]"><code>proc_macro::TokenStream</code></code><br>ä½†æ²¡å…³ç³», åˆ«äººæ—©å°±å…¨å¸®ä½ å‡†å¤‡å¥½äº†, åœ¨ä¸¤è€…è¿›è¡Œè½¬æ¢æ—¶, åªéœ€è¦è°ƒç”¨ä¸€ä¸‹ <code class="font-semibold text-[#aa8bd5]"><code>.into()</code></code> å°± OK äº†<br><br>è®©æˆ‘ä»¬æ¥å®é™…æ„Ÿå—ä¸€ä¸‹ä¸Šé¢æ‰€è¯´çš„å†…å®¹:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// src/lib.rs
use proc_macro::TokenStream;
use proc_macro2::TokenTree;
use quote::quote;

#[proc_macro_attribute]
pub fn curry(_attr: TokenStream, input: TokenStream) -> TokenStream {
    let parsed = syn::parse_macro_input!(input as syn::ItemFn);

    let (body, sig, vis) = (parsed.block, parsed.sig, parsed.vis);
    let (fn_ident, fn_args, fn_return_type) = sig.ident, fn_args = sig.inputs, sig.output);

    let new_fn = quote!(
        #vis fn #fn_ident (#fn_args) #fn_return_type {
            #body
        }
    );

    // TokenStream å®ç°äº† std::fmt::Display, æ‰€ä»¥å¯ä»¥é€šè¿‡ `println!` æ‰“å°è¿›è¡Œ debug
    println!("{}\n", new_fn);

    new_fn.into()
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æ ¹æ®ä»£ç ç»§ç»­åŠ æ·±å°è±¡:<br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>proc-macro2</code></code>:<br></li>
      </ul>
      <p>ç›¸å½“äº <code class="font-semibold text-[#aa8bd5]"><code>proc-macro</code></code> çš„åŒ…è£…, åŸºäºä¸‰å‰‘å®¢æœ€åç”Ÿæˆçš„æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>proc_macro2::TokenStream</code></code>, ä½†ä¼ ç»™ç¼–è¯‘å™¨çš„å¾—æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>proc_macro::TokenStream</code></code> æ‰€ä»¥è¦è°ƒç”¨ <code class="font-semibold text-[#aa8bd5]"><code>.into</code></code><br><br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>syn</code></code>:<br></li>
      </ul>
      <p>æä¾›äº†è®¸å¤šé«˜æŠ½è±¡çš„ç»“æ„å¸®åŠ©è§£æ, æ¯”å¦‚è¿™é‡Œæˆ‘ä»¬å°†åŸå§‹çš„ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code> ç±»å‹çš„ <code class="font-semibold text-[#aa8bd5]"><code>input</code></code> ç»™è½¬æ¢ä¸ºäº† <code class="font-semibold text-[#aa8bd5]"><code>ItemFn</code></code><br>éšåå°†ä»å·²ç»è¢«è§£æåŒ…è£…ä¸º <code class="font-semibold text-[#aa8bd5]"><code>ItemFn</code></code> ç±»å‹çš„å˜é‡ä¸­, æå–äº†å‡½æ•°ä½“, å‡½æ•°ç­¾å, å‡½æ•°å¯è§æ€§ä¿®é¥°ç¬¦(ä¸æ˜¯<code class="font-semibold text-[#aa8bd5]"><code>pub</code></code>å°±æ˜¯ç©º)<br>éšåä»å‡½æ•°ç­¾åä¸Šå¾—åˆ°äº†å‡½æ•°çš„åç§°, å‡½æ•°çš„å‚æ•°, å‡½æ•°çš„è¿”å›ç±»å‹<br>(ä¸ç„¶ä½ å°±å¾—è‡ªå·±è¿›è¡Œè§£ææŠ½è±¡äº†å“¦)<br><br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>quote</code></code>:<br></li>
      </ul>
      <p>åœ¨ <code class="font-semibold text-[#aa8bd5]"><code>quote!</code></code> å®é‡Œé¢, æˆ‘ä»¬ä»¥ <code class="font-semibold text-[#aa8bd5]"><code>#å˜é‡åç§°</code></code> çš„å½¢å¼è¿›è¡Œæ’å€¼, ç±»ä¼¼äº <code class="font-semibold text-[#aa8bd5]"><code>format!("{a}")</code></code> ä¸­çš„ <code class="font-semibold text-[#aa8bd5]"><code>{a}</code></code>, ä¸è¿‡ç”Ÿæˆçš„æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>proc_macro2::TokenStream</code></code><br>æˆ‘ä»¬è¿™é‡Œä»…ä»…æ˜¯åŸå°ä¸åŠ¨çš„è§£ææ‹†è§£äº†è¾“å…¥, ç„¶ååŸå°ä¸åŠ¨åœ°ç»„è£…å›å»ä½œä¸ºäº†è¾“å‡º<br><br>è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹å¯ä¸å¯ä»¥é€šè¿‡ç¼–è¯‘, åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹ <code class="font-semibold text-[#aa8bd5]"><code>tests/</code></code>:</p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// tests/test.rs
use curried::curry;

#[curry]
fn add(a: i32, b: i32, c: i32) -> i32 {
    a + b + c
}

#[test]
fn test() {
    let x = add(1, 2, 3);
    assert_eq!(x, 6);
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>è‹¥è¿è¡Œ <code class="font-semibold text-[#aa8bd5]"><code>cargo test</code></code>, åˆ™ç¼–è¯‘ä¼šé¡ºåˆ©é€šè¿‡<br>ä½ ä¹Ÿå¯ä»¥ç¨åŠ ä¿®æ”¹, æ¯”å¦‚ç»™ç”Ÿæˆå‡½æ•°çš„åå­—å¢åŠ ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>new_</code></code> çš„å‰ç¼€:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">//  src/lib.rs
use proc_macro::TokenStream;
use quote::{format_ident, quote};

#[proc_macro_attribute]
pub fn curry(_attr: TokenStream, item: TokenStream) -> TokenStream {
    let parsed = syn::parse_macro_input!(item as syn::ItemFn);

    let (body, sig, vis) = (parsed.block, parsed.sig, parsed.vis);
    let (fn_ident, fn_args, fn_return_type) = (sig.ident, sig.inputs, sig.output);

    let new_fn_ident = format_ident!("new_{fn_ident}"); // here
    let new_fn = quote!(
                // here
        #vis fn #new_fn_ident (#fn_args) #fn_return_type {
            #body
        }
    );

    // TokenStream å®ç°äº† std::fmt::Display, æ‰€ä»¥å¯ä»¥é€šè¿‡ `println!` æ‰“å°è¿›è¡Œ debug
    println!("{}\n", new_fn);

    new_fn.into()
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>ç°åœ¨ <code class="font-semibold text-[#aa8bd5]"><code>test.rs</code></code> ä¸­åº”è¯¥ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯, å› ä¸ºç°åœ¨ç”Ÿæˆçš„æ–°å‡½æ•°çš„åå­—å·²ç»å˜æˆäº† <code class="font-semibold text-[#aa8bd5]"><code>new_add</code></code><br>è€Œå¯¹äºæŸ¯é‡ŒåŒ–, æˆ‘ä»¬ä»…éœ€åœ¨ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code> è¢«è§£ææŠ½è±¡ä¸º <code class="font-semibold text-[#aa8bd5]"><code>ItemFn</code></code> çš„åŸºç¡€ä¸Š, ä¿®æ”¹å®ƒçš„ <em>å‡½æ•°ç­¾å</em> ä¸ <em>å‡½æ•°ä½“</em> å³å¯:<br><br></p>
      <ul class="list-disc ml-5">
        <li><em>å‡½æ•°ç­¾å</em>: æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>fn f(#ident1: #type1) -> impl FnOnce(#type2) -> impl FnOnce(#type3) -> impl FnOnce(#type4) ... -> #typen</code></code> çš„å½¢å¼</li>
        <li><em>å‡½æ•°ä½“</em>: æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>move |#ident2| move |#ident3| ... #body</code></code> çš„å½¢å¼</li>
      </ul>
      <p><br>åˆ«å¿˜äº†å¿…é¡»ä½¿ç”¨ <code class="font-semibold text-[#aa8bd5]"><code>move</code></code> å…³é”®å­—å¼ºåˆ¶å°†è¢«æ•è·å˜é‡çš„æ‰€æœ‰æƒäº¤ç»™é—­åŒ…, ä¿è¯äº†ä½œä¸ºå‡½æ•°è¿”å›å€¼ä¼ æ’­çš„é—­åŒ…, å…¶ç”Ÿå‘½å‘¨æœŸé•¿äºè¢«æ•è·çš„å˜é‡<br>ç”±äºå‡½æ•°ä½“å†…å¯èƒ½ä¼šæ¶ˆè´¹å‚æ•°(è¢«æ•è·å˜é‡)çš„æ‰€æœ‰æƒ, æ‰€ä»¥æˆ‘ä»¬åº”è¯¥ç»Ÿä¸€å†™æˆ <code class="font-semibold text-[#aa8bd5]"><code>FnOnce</code></code><br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">#![feature(impl_trait_in_fn_trait_return)]

fn add(a: i32) -> impl FnOnce(i32) -> impl FnOnce(i32) -> i32 {
    move |b| move |c| a + b + c
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æœ€æ˜æ˜¾çš„éš¾ç‚¹è‡ªç„¶åœ¨äºå¦‚ä½•ç”Ÿæˆè¿™æ ·çš„å½¢å¼, å…ˆè®©æˆ‘ä»¬å®Œå–„è§£å†³é—®é¢˜çš„æ€è·¯, æ­å»ºå‡ºæ¥åŸºæœ¬çš„éª¨æ¶ç»“æ„:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// src/lib.rs
use proc_macro::TokenStream;
use quote::quote;
use syn::{parse_macro_input, Block, FnArg, ItemFn, Pat, ReturnType, Type};

#[proc_macro_attribute]
pub fn curry(_attr: TokenStream, item: TokenStream) -> TokenStream {
    let parsed = parse_macro_input!(item as ItemFn);

    let (body, sig, vis) = (parsed.block, parsed.sig, parsed.vis);

    let fn_return_type = sig.output;
    let (fn_ident, fn_args) = (sig.ident, sig.inputs);
    let (impl_generics, _ty_generics, where_clause) = sig.generics.split_for_impl();

    let mut arg_idents = vec![];
    let mut arg_types = vec![];
    for arg in fn_args.into_iter() {
        let (ident, ty) = match arg {
            FnArg::Typed(p) => (p.pat, p.ty),
            FnArg::Receiver(_) => panic!("self parameter is unsupported now"),
        };
        arg_idents.push(ident);
        arg_types.push(ty);
    }

    let return_type = generate_return_type(&amp;arg_types, fn_return_type);
    let body = generate_body(&amp;arg_idents, &amp;arg_types, body);
    let first_arg_ident = arg_idents.first().unwrap();
    let first_arg_type = arg_types.first().unwrap();

    let first_arg = if first_arg_ident.is_some() {
        quote!(#first_arg_ident: #first_arg_type)
    } else {
        quote!()
    };

    let new_fn = quote!(
        #vis fn #fn_ident #impl_generics (#first_arg) #return_type #where_clause {
            #body
        }
    );

    new_fn.into()
}

fn generate_return_type(
    types: &amp;[Box&lt;Type>], 
    fn_return_type: ReturnType,
) -> proc_macro2::TokenStream {
    todo!()
}

fn generate_body(
    idents: &amp;[Box&lt;Pat>],
    types: &amp;[Box&lt;Type>],
    body: Box&lt;Block>,
) -> proc_macro2::TokenStream {
    todo!()
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æˆ‘ä»¬ä» <em>å‡½æ•°ç­¾å</em> ä¸­å¾—åˆ°äº† <em>å‡½æ•°ä½“</em>, <em>è¿”å›ç±»å‹</em>, è¿˜æœ‰å‚æ•°ä¸­çš„ <em>Pat(pattern, æ¨¡å¼)</em> (ç±»å‹ <code class="font-semibold text-[#aa8bd5]"><code>x: i32</code></code> è¿™æ ·çš„å½¢å¼ä¸ºä¸€å¯¹ <em>Pat</em>)<br>æˆ‘ä»¬ç•™ä¸‹äº†ä¸¤ä¸ªç©ºå®ç°çš„å‡½æ•°, é€šè¿‡ä¼ é€’è¿›æ¥ <em>åˆ‡ç‰‡(slice)</em> (è¯¸å¦‚æ–‡ä¸­çš„ <code class="font-semibold text-[#aa8bd5]"><code>&amp;[Box&lt;Type>]</code></code>) æ¥è§£å†³å…ˆå‰çš„ä¸¤ä¸ªéš¾ç‚¹<br>æˆ‘ä»¬è¿˜é€šè¿‡ <code class="font-semibold text-[#aa8bd5]"><code>quote!</code></code> è¿›è¡Œäº†æ’å€¼, åœ¨ <code class="font-semibold text-[#aa8bd5]"><code>curry</code></code> ä¸­ç”Ÿæˆæ–°çš„ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code> å¹¶è¿”å›<br></p>
      <p>è®©æˆ‘ä»¬å…ˆå®Œæˆ <code class="font-semibold text-[#aa8bd5]"><code>generate_return_type</code></code> çš„éƒ¨åˆ†å¹¶ä»‹ç» <code class="font-semibold text-[#aa8bd5]"><code>quote!</code></code> çš„ <em>é‡å¤æ’å€¼(repeat)</em>:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// src/lib.rs
fn generate_return_type(
    types: &amp;[Box&lt;Type>],
    fn_return_type: ReturnType,
) -> proc_macro2::TokenStream {
    let last = types.len();
    let range = 1..last;

    let types = &amp;types[range];

    let fn_return_type = quote!(
        #( -> impl Fn(#types) )* #fn_return_type
    );

    fn_return_type
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <ul class="list-disc ml-5">
        <li>åœ¨ <code class="font-semibold text-[#aa8bd5]"><code>quote!</code></code> ä¸­çš„ <code class="font-semibold text-[#aa8bd5]"><code>#(...)*</code></code> é‡Œé¢ä¼šè¿›è¡Œé‡å¤æ’å€¼, å®ƒæ¥å—ä¸€ä¸ªå…ƒç´ å®ç°äº† <code class="font-semibold text-[#aa8bd5]"><code>ToTokens</code></code> çš„è¿­ä»£å™¨å¹¶é‡å¤åœ°æå–æ’å…¥<br></li>
        <li>å…ˆå‰è¯´ <code class="font-semibold text-[#aa8bd5]"><code>impl Fn</code></code> æ¯”è¾ƒé€šç”¨, æ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† <code class="font-semibold text-[#aa8bd5]"><code>impl Fn</code></code> ä½œä¸ºè¿”å›å€¼ç±»å‹, ä½†è¯·è®°ä½, æˆ‘ä»¬ä¹‹åä¼šå°†å…¶æ›´æ”¹, åŸå› ä¸ <code class="font-semibold text-[#aa8bd5]"><code>move</code></code> ç§»åŠ¨æ‰€æœ‰æƒæœ‰å…³<br></li>
      </ul>
      <p><br>åŒç†, è®©æˆ‘ä»¬ç»§ç»­å®Œæˆ <code class="font-semibold text-[#aa8bd5]"><code>generate_body</code></code>:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// src/lib.rs
fn generate_body(
    idents: &amp;[Box&lt;Pat>],
    types: &amp;[Box&lt;Type>],
    body: Box&lt;Block>,
) -> proc_macro2::TokenStream {
    let last = types.len();
    let range = 1..last;

    let types = &amp;types[range.clone()];
    let idents = &amp;idents[range];

    let body = quote!(
        #( move |#idents: #types| )* #body
    );

    body
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œ <code class="font-semibold text-[#aa8bd5]"><code>cargo t</code></code>, ä½ ä¼šçœ‹è§ç”¨äº debug çš„ <code class="font-semibold text-[#aa8bd5]"><code>println</code></code> æ‰“å°äº†æœ€åçš„ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code> å¹¶é€šè¿‡æµ‹è¯•:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// tests/test.rs
#![feature(impl_trait_in_fn_trait_return)]
use curried::curry;

#[curry]
fn add(a: i32, b: i32, c: i32) -> i32 {
    a + b + c
}

#[test]
fn test() {
    let x = add(1)(2)(3);
    assert_eq!(x, 6);
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>çœ‹èµ·æ¥å¾ˆä¸é”™, ä¸è¿‡å…¶å®ä¸Šé¢çš„ <code class="font-semibold text-[#aa8bd5]"><code>add</code></code> å¹¶æ²¡æœ‰ <em>æ¶ˆè´¹å‚æ•°(è¢«æ•è·å˜é‡)çš„æ‰€æœ‰æƒ</em>, å› ä¸º <code class="font-semibold text-[#aa8bd5]"><code>i32</code></code> å®ç°äº† <code class="font-semibold text-[#aa8bd5]"><code>Copy</code></code><br>è®©æˆ‘ä»¬è¯•è¯•åœ¨å‡½æ•°ä½“å†…æ¶ˆè´¹å‚æ•°çš„æ‰€æœ‰æƒ:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// tests/test.rs
#![feature(impl_trait_in_fn_trait_return)]
use curried::curry;

#[curry]
fn concat_string(a: String, b: String, c: String) -> String {
    format!("{a}{b}{c}")
}

#[test]
fn test() {
    let s1 = String::from("1");
    let s2 = String::from("23");
    let s3 = String::from("456");

    let x = concat_string(s1)(s2)(s3);
    assert_eq!(x, String::from("123456"));
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>é¡ºåˆ©é€šè¿‡ç¼–è¯‘, æ¯•ç«Ÿæˆ‘ä»¬ä¸ºè¿”å›å€¼ç±»å‹ç”Ÿæˆçš„æ˜¯ impl FnOnce, ä½†å€˜è‹¥ä½ æ”¹æˆ impl Fn çš„æ ·å­, å°±ä¼šå¾—åˆ°è¿™æ ·çš„æŠ¥é”™:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-text text-sm sm:text-base">error[E0507]: cannot move out of `a`, a captured variable in an `Fn` closure
  --> tests/test.rs:10:1
   |
10 | #[curry]
   | ^^^^^^^^
   | |
   | captured by this `Fn` closure
   | `a` is moved here
11 | fn concat_string(a: String, b: String, c: String) -> String {
   |                  - captured outer variable
12 |     format!("{a} {b} {c}")
   |               -
   |               |
   |               variable moved due to use in closure
   |               move occurs because `a` has type `String`, which does not implement the `Copy` trait</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å¦‚æœå†™æˆ <code class="font-semibold text-[#aa8bd5]"><code>impl Fn</code></code>, å¯¹äºå‚æ•°æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>String</code></code> çš„æƒ…å†µä¼šæŠ¥é”™, å¯¹äºæ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>i32</code></code> çš„æƒ…å†µä¸ä¼šæŠ¥é”™, å› ä¸ºåè€…å®ç°äº† <code class="font-semibold text-[#aa8bd5]"><code>Copy</code></code><br>è¿™æ›´åŠ è¯æ˜äº†æˆ‘ä»¬å¾—å†™æˆ <code class="font-semibold text-[#aa8bd5]"><code>impl FnOnce</code></code> çš„å½¢å¼<br><br>æˆ‘ä»¬ç»ˆäºæˆåŠŸå†™å‡ºäº†ä¸€ä¸ªå¯ä»¥å¯¹æ™®é€šå‡½æ•°è¿›è¡ŒæŸ¯é‡ŒåŒ–çš„å±æ€§å®äº†, æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹ä¸¤ç§ç‰¹æ®Šæƒ…å†µ<br>(è¯´æ˜¯ç‰¹æ®Šæƒ…å†µ, å…¶å®ä¹Ÿæ˜¯å¸¸è§åœºæ™¯â€¦)<br><br></p>
      <ul class="list-disc ml-5">
        <li>æ‹¥æœ‰æ³›å‹çš„å‡½æ•°<br></li>
        <li>è¿­ä»£å™¨çš„ <code class="font-semibold text-[#aa8bd5]"><code>map</code></code> ä¸­å¯¹å›è°ƒå‡½æ•°çš„ <code class="font-semibold text-[#aa8bd5]"><code>FnMut</code></code> çº¦æŸéœ€æ±‚<br></li>
      </ul>
      <h2 class="flex items-center w-fit my-6" id="rang-hong-zhi-chi-fan-xing"><span class="text-2xl m-2 text-cyan-500">></span> <a class="text-2xl hover:underline underline-offset-8" href="#rang-hong-zhi-chi-fan-xing">è®©å®æ”¯æŒæ³›å‹</a></h2>
      <p>æˆ‘ä»¬å…ˆå‰å·²ç»å°†è¾“å…¥å‚æ•°ä¸­çš„æ³›å‹éƒ¨åˆ†ç²˜è´´ä¸Šå»äº†, æ‰€ä»¥ç°åœ¨ç›´æ¥è¿›è¡Œæµ‹è¯•:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// tests/test.rs
#[curry]
fn concat&lt;T: std::fmt::Display>(a: T, b: T, c: T) -> String {
    format!("{a} {b} {c}")
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-text text-sm sm:text-base">fn concat &lt; T : std :: fmt :: Display > (a : T) -> impl FnOnce(T) -> impl
FnOnce(T) -> String
{ move | b : T | move | c : T | { format! ("{a} {b} {c}") } }

error: concrete type differs from previous defining opaque type use
  --> tests/test.rs:16:1
   |
16 | #[curry]
   | ^^^^^^^^ expected `impl FnOnce(T) -> String`, got `{closure@tests/test.rs:16:1: 16:9}`
   |
note: previous use here
  --> tests/test.rs:16:1
   |
16 | #[curry]
   | ^^^^^^^^
   = note: this error originates in the attribute macro `curry` (in Nightly builds, run with -Z macro-backtrace for more info)

error[E0720]: cannot resolve opaque type
  --> tests/test.rs:16:1
   |
16 | #[curry]
   | ^^^^^^^^ cannot resolve opaque type</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>çœ‹ä¸æ‡‚å•Š? ä»€ä¹ˆé¬¼? ä¸ºä»€ä¹ˆä¼šæŠ¥é”™?<br>å“ˆå“ˆå•Šå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå…¶å®è¿™æ˜¯ ç¼–è¯‘å™¨çš„bug, æˆ‘tmé‡è§çš„æ—¶å€™æœäº†å¥½å¤šèµ„æ–™æœä¸åˆ°è§£é‡Š, å¿«ç–¯äº†å¿«ç–¯äº†å¿«ç–¯äº†å“ˆå“ˆå“ˆå“ˆå•Šå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå™—å™—å™—å™—å™—å™—å™—å™—å•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œå—·å—·å—·å‘œå‘œå‘œå‘œå‘œå‘œå‘œå‘œå“ˆå“ˆå“ˆå“ˆå“ˆå‘œå‘œå‘œå‘œå‘œ (ä¸æ˜¯<br><br>ä½†è¯·åˆ«åœ¨æ„, ä»£ç æœ¬èº«å†™çš„å…¶å®æ˜¯æ²¡æœ‰é—®é¢˜çš„, ä½†æ¯•ç«Ÿå¼€äº† nightly ä¸‹çš„ feature, è€Œä¸”æˆ‘ä»¬ä¾æ—§æœ‰æ–¹æ³•ç»•è¿‡å»<br><br>å½“å®é‡è§ bug æ—¶, æˆ‘ä»¬å…ˆå‰ç•™ä¸‹ç”¨æ¥ debug çš„ <code class="font-semibold text-[#aa8bd5]"><code>println</code></code> æ‰“å°äº†ç”Ÿæˆçš„ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code><br>è‡³å°‘å¯¹æˆ‘ä¸ªäººæ¥è¯´, æˆ‘æ˜¯é€šè¿‡å°†æ‰“å°ç»“æœç²˜è´´ä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ–°å‡½æ•°å¿«é€Ÿä¿®æ”¹, æ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆ:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// Failed to compile
fn concat_1&lt;T: std::fmt::Display>(a: T) -> impl FnOnce(T) -> impl FnOnce(T) -> String {
    move |b: T| move |c: T| format!("{a} {b} {c}")
}
é€šè¿‡ä¿®æ”¹, æˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•é¡ºåˆ©ç¼–è¯‘ (è¿™çœŸçš„æ˜¯bug, å½“ä½ é˜…è¯»æœ¬ç¯‡æ—¶å¯èƒ½å·²è¢«ä¿®å¤):// Sucessful
fn concat_1&lt;T: std::fmt::Display>(a: T) -> impl FnOnce(T) -> impl FnOnce(T) -> String {
    (|| move |b: T| move |c: T| format!("{a} {b} {c}"))()
}

// Sucessful
fn concat_1&lt;T: std::fmt::Display>(a: T) -> impl FnOnce(T) -> impl FnOnce(T) -> String {
    (move |b: T| move |c: T| format!("{a} {b} {c}"), ).0
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å“Ÿè¥¿, æ—¢ç„¶æ‰¾åˆ°äº†è§£å†³æ–¹æ³•, è®©æˆ‘ä»¬ä¿®æ”¹å®å§:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// src/lib.rs
fn generate_body(
    // ...
) -> proc_macro2::TokenStream {
    // ...
    // ...
    let body = quote!(
        ( #( move |#idents: #types| )* #body ,).0
    );

    body
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>é¡ºåˆ©è§£å†³äº†, ä½†å¦‚æœæˆ‘ä»¬æƒ³åœ¨ stable æƒ…å†µä¸‹ç¼–è¯‘, åˆ™å¯ä»¥é€šè¿‡ä½¿ç”¨ <code class="font-semibold text-[#aa8bd5]"><code>Box&lt;dyn Trait></code></code> æ¥æ„é€  <em>trait-object</em><br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// src/lib.rs
fn generate_return_type(
    types: &amp;[Box&lt;Type>],
    fn_return_type: ReturnType,
) -> proc_macro2::TokenStream {
    let last = types.len();
    let range = 1..last;
    let len = range.len();

    let types = &amp;types[range.clone()];

    let fn_return_type = quote!(#fn_return_type).to_string();
    let mut token_stream = String::new();
    for ty in types.iter() {
        let ty = quote!(#ty);
        token_stream += &amp;format!("-> Box&lt;dyn FnOnce({ty})");
    }
    token_stream += &amp;fn_return_type;
    token_stream += &amp;">".repeat(len);

    proc_macro2::TokenStream::from_str(&amp;token_stream).unwrap()
}

fn generate_body(
    idents: &amp;[Box&lt;Pat>],
    types: &amp;[Box&lt;Type>],
    body: Box&lt;Block>,
) -> proc_macro2::TokenStream {
    let last = types.len();
    let range = 1..last;
    let len = range.len();

    let idents = &amp;idents[range.clone()];
    let types = &amp;types[range];

    let body = quote!(#body);
    let mut token_stream = String::new();
    for (id, ty) in idents.iter().zip(types.iter()) {
        let (ident, ty) = (quote!(#id), quote!(#ty));
        token_stream += &amp;format!("Box::new( move |{ident}: {ty}| ");
    }
    token_stream += &amp;format!("{body}");
    token_stream += &amp;")".repeat(len);

    proc_macro2::TokenStream::from_str(&amp;token_stream).unwrap()
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æˆ‘ä»¬æ„é€ äº† <code class="font-semibold text-[#aa8bd5]"><code>Box&lt;dyn FnOnce(T) -> Box&lt;dyn FnOnce(T) -> String>></code></code> ä¸ <code class="font-semibold text-[#aa8bd5]"><code>Box::new(move |b| Box::new(move |c| -> #body))</code></code><br>è¿™éœ€è¦åœ¨æœ«å°¾é…é½ <code class="font-semibold text-[#aa8bd5]"><code>></code></code> ä¸ <code class="font-semibold text-[#aa8bd5]"><code>)</code></code> è¿™ä¸¤ç§æ‹¬å·, å› æ­¤æˆ‘ä»¬ç›´æ¥æ“æ§å­—ç¬¦ä¸², ç„¶åè°ƒç”¨ <code class="font-semibold text-[#aa8bd5]"><code>from_str</code></code> è½¬æˆ <code class="font-semibold text-[#aa8bd5]"><code>TokenStream</code></code> å³å¯(è®°å¾— <code class="font-semibold text-[#aa8bd5]"><code>use std::str::FromStr</code></code>)<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="zi-dong-tui-dao-lei-xing"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#zi-dong-tui-dao-lei-xing">è‡ªåŠ¨æ¨å¯¼ç±»å‹</a></h1>
      <p>æˆ‘ä»¬å·²ç»è§£å†³äº†æ³›å‹çš„æƒ…å†µ, ä½†ä»ç„¶æœ‰ä¸€ç§æƒ…å†µæˆ‘ä»¬æ— æ³•é€šè¿‡, é‚£å°±åœ¨éœ€æ±‚ä¼ å…¥ <code class="font-semibold text-[#aa8bd5]"><code>Fn/FnMut</code></code> çš„åœ°æ–¹:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">#[curry]
fn add(a: i32, b: i32, c: i32) -> i32 {
    a + b + c
}

// Expected: [4, 5, 6]
// But failed to compile
[1, 2, 3].map(add(1)(2))</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å› ä¸ºæˆ‘ä»¬çš„ <em>å±æ€§å®</em> ç”Ÿæˆçš„æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>impl FnOnce</code></code>, è‡ªç„¶æ— æ³•ä¼ é€’ç»™éœ€è¦ <code class="font-semibold text-[#aa8bd5]"><code>FnMut</code></code> çš„ <code class="font-semibold text-[#aa8bd5]"><code>map</code></code> ä¸­, åªèƒ½åœ¨ç›¸åŒä½œç”¨åŸŸå†…ä¾é è‡ªåŠ¨ç±»å‹æ¨å¯¼:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn add(a: i32, b: i32, c: i32) -> i32 {
    a + b + c
}

let f = move |a| move |b| move |c| map(a, b, c);
[1, 2, 3].map(f);</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å½“ç„¶, æˆ‘ä»¬ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªç®€åŒ–æ“ä½œçš„å® (è™½ç„¶æ²¡ç®€åŒ–å¤šå°‘):<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">#[proc_macro]
pub fn to_curry(input: TokenStream) -> TokenStream {
    let input = proc_macro2::TokenStream::from(input);

    let (mut fn_name, mut body) = (None, None);
    let mut not_in_body = true;
    let mut args = vec![];

    for tt in input {
        match tt {
            TokenTree::Group(group) => {
                body = Some(group);
                break;
            }
            TokenTree::Ident(ident) if not_in_body => {
                fn_name = Some(ident);
                not_in_body = false;
            }
            _ => (),
        }
    }
    for tt in body.clone().unwrap().stream().into_iter() {
        if let TokenTree::Ident(ident) = tt {
            args.push(ident)
        }
    }

    let body = body.unwrap();
    let closure = quote!(
        #( move |#args| )* #fn_name #body
    );

    closure.into()
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>ç°åœ¨å¯ä»¥è¿™æ ·:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">let f = to_curry!(add(a, b, c));
[1, 2, 3].map(f(1)(2)); // [4, 5, 6]</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å°±æ­¤, æœ¬æ–‡å®Œç»“å•¦!<br>æ„Ÿè°¢ä½ çš„è§‚çœ‹!<br></p>
      <hr class="border-2 border-dashed my-10">
      <div class="flex flex-col sm:mx-2 *:my-2"><a class="flex items-center border-2 border-slate-500 w-full sm:rounded-md hover:border-white  justify-end " href="/posts/rust-typed-magic/gats" hx-get="/posts/rust-typed-magic/gats/index.html" hx-target="body" hx-push-url="/posts/rust-typed-magic/gats" hx-swap="innerHTML show:window:top"><span class="text-2xl sm:text-4xl sm:p-2 pr-2 pl-1 order-last ">></span> <span class="text-xl sm:text-2xl sm:p-2">æ³›å‹å…³è”ç±»å‹</span></a></div>
    </div>
  </body>
</html>
