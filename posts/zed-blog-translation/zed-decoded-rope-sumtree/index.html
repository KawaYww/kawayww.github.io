<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æŸ³ä¸Šå·</title><meta name="description" content="æŸ³ä¸Šå·çš„åšå®¢"/><link rel="shortcut icon" href="/images/blog/avatar.avif" type="image/avif"/><link rel="stylesheet" href="/styles/highlight.min.css"/><link rel="stylesheet" href="/fonts/MapleMono-NF-CN-Regular/result.css"/><link rel="stylesheet" href="/fonts/MapleMono-NF-CN-Italic/result.css"/><link rel="stylesheet" href="/fonts/MapleMono-NF-CN-Bold/result.css"/><link rel="stylesheet" href="/styles/catppuccin-macchiato.css"/><link rel="stylesheet" href="/iconfonts/iconfont.css"/><link rel="stylesheet" href="/styles/tailwind.css"/><script src="/scripts/highlight.min.js"> </script><script src="/scripts/rust.min.js"> </script><script src="/scripts/nix.min.js"> </script><script src="/scripts/scheme.min.js"> </script><script src="/scripts/htmx.min.js"> </script><script src="/scripts/prefetch.js"> </script><script src="/scripts/custom.js"> </script><meta name="darkreader-lock"></head>
  <body>
    <div id="content" class="flex flex-col mx-4 mb-20 scroll-smooth" lang="zh-Hans">
      <div class="text-2xl sm:text-3xl my-4 w-full text-center">ã€Rope &amp; SumTreeã€</div>
      <div class="font-medium w-fit sm:mx-auto flex flex-col border-l-4 pl-2 sm:flex-row sm:border-l-0 sm:pl-0">
        <p>[å†™è‡ª:2024-10-01</p>
        <div class="px-2 hidden sm:inline">â”‚</div>
        <p>ä½œè€…:æŸ³ä¸Šå·</p>
        <div class="px-2 hidden sm:inline">â”‚</div>
        <p>ç³»åˆ—:<a class="underline underline-offset-5" href="/categories/zed-blog-translation" hx-get="/categories/zed-blog-translation/index.html" hx-target="body" hx-push-url="/categories/zed-blog-translation" hx-swap="innerHTML show:window:top">zed-blog-translation</a>]</p>
      </div>
      <div class="flex flex-col items-center m-4">
        <div class="w-fit mx-auto text-lg font-semibold">æ‘˜è¦</div>
        <div class="w-fit break-keep text-center sm:mx-[25%] *:inline">å¯¹åšå®¢ <a class="underline underline-offset-5 font-medium" href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed Decoded: Rope &amp; SumTree</a> çš„ç¿»è¯‘</div>
      </div>
      <div class="flex flex-col my-10 w-fit border-2 border-slate-500">
        <p><span class="text-2xl">ç›®å½•:</span></p>
        <div class="w-fit pr-2 my-2">
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”Œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#kai-pian">å¼€ç¯‡</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#wei-he-bu-yong-zi-fu-chuan">ä¸ºä½•ä¸ç”¨å­—ç¬¦ä¸²?</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#zi-fu-chuan-de-wen-ti">å­—ç¬¦ä¸²çš„é—®é¢˜</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#bi-zi-fu-chuan-geng-hao-de-shi">æ¯”å­—ç¬¦ä¸²æ›´å¥½çš„æ˜¯?</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#ropes">Ropes</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#zedde-shi-xian">Zedçš„å®ç°</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#wei-he-zedshi-yong-rope">ä¸ºä½•Zedä½¿ç”¨rope?</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#yin-ru-sumtree">å¼•å…¥SumTree</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#bian-li-sumtree">éå†SumTree</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â”œâ”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#shi-yong-sumtree">ä½¿ç”¨ SumTree</a></span></div>
          <div class="leading-5"><span class="pl-2"><span class="font-bold text-sm">â””â”€â–º</span><a class="text-sm hover:text-sky-500 hover:font-semibold hover:underline underline-offset-5" href="#quan-du-shi-sumtree">å…¨éƒ½æ˜¯SumTree</a></span></div>
        </div>
      </div>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="kai-pian"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#kai-pian">å¼€ç¯‡</a></h1>
      <p>è¿™æ˜¯ Zed-Decoded ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬çš„åšå®¢ä¸è§†é¢‘å°†æ›´æ·±å…¥åœ°æ¢è®¨: Zed æ˜¯å¦‚ä½•æ„å»ºçš„<br>æˆ‘ä¸ Zed çš„ä¸‰ä½è”åˆåˆ›å§‹äºº: Nathan, Max, Antonio ä¸€èµ·è®¨è®ºäº†ä½œä¸º Zed æ ¸å¿ƒçš„æ•°æ®ç»“æ„ï¼šrope<br>(è¯‘è€…æ³¨: youtube ä¸Šçš„é…å¥—è§†é¢‘: <a class="underline underline-offset-5 font-medium" href="https://youtu.be/uUu9eFNNbjg">ä¼ é€é—¨</a>)<br><br>æˆ‘ä¸€ç›´ä¸å¤ªç†è§£ Zed çš„ rope æ˜¯å¦‚ä½•å®ç°çš„, ä»¥åŠå…¶å¸¦æ¥äº†ä»€ä¹ˆå¥½å¤„, æ‰€ä»¥æˆ‘é—®äº†ä»–ä»¬ (è¿™ä¹ˆå¤šå¹´æ¥, ä»–ä»¬ä¸€ç›´åœ¨å†™å…³äº rope çš„ä»£ç )<br>äº‹å®è¯æ˜, Zed ä¸­çš„ rope å¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ rope, è¿™è®©äººå½¢è±¡æ·±åˆ»<br><br>ä½†é¦–å…ˆ, ä»€ä¹ˆæ˜¯ rope?<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="wei-he-bu-yong-zi-fu-chuan"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#wei-he-bu-yong-zi-fu-chuan">ä¸ºä½•ä¸ç”¨å­—ç¬¦ä¸²?</a></h1>
      <p>æ–‡æœ¬ç¼–è¾‘å™¨å¿…é¡»åšçš„ä¸€ä»¶æœ€é‡è¦çš„äº‹æƒ…,å°±æ˜¯å»ä»¥æŸç§æ–¹å¼è¡¨ç¤ºæ–‡æœ¬(text), ä½ å¸Œæœ›åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€æ–‡ä»¶æ—¶, å¯ä»¥æµè§ˆå¹¶ç¼–è¾‘å…¶ä¸­çš„å†…å®¹<br>ä¸ºæ­¤, ç¼–è¾‘å™¨å¿…é¡»å°†æ–‡ä»¶çš„å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­, ç”¨æˆ·ä¸è¯¥ç›¯ç€ç£ç›˜ä¸ŠåŸå§‹çš„å­—èŠ‚, ä¸”æ¯ä¸ªç¼–è¾‘æ›´æ”¹çš„æ“ä½œä¸åº”è¯¥éƒ½ç«‹åˆ»ä¿å­˜åœ¨ç£ç›˜ä¸­<br><br>æ‰€ä»¥é—®é¢˜æ¥äº†: å¦‚ä½•åœ¨å†…å­˜ä¸­è¡¨ç¤ºæ–‡æœ¬å‘¢?<br><br>æˆ‘å¤©çœŸæ— æ¯”çš„ç¬¬ä¸€ä¸ªæƒ³æ³•å°±æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²(String), Good old string, æˆ‘ä»¬åˆšåˆšå¼€å§‹ç¼–ç¨‹æ—¶æœ€å¥½çš„æœ‹å‹!<br>ä¸ºä»€ä¹ˆä¸ç”¨å®ƒå‘¢? æˆ‘ä»¬ä¸€ç›´è¿™æ ·åœ¨å†…å­˜ä¸­è¡¨ç¤ºæ–‡æœ¬, è¿™ä¸æ˜¯ä¸ªç³Ÿç³•çš„é€‰æ‹©, å¯¹å§?<br><br>å˜¿, æˆ‘æ•¢æ‰“èµŒç”¨ String å¯ä»¥èµ°å¾ˆè¿œ, ä½†å…¶ä¾ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ä»¥è‡³äºå¹¶éæœ€ä½³é€‰é¡¹, å¸Œæœ›ç¨‹åºå¤„ç†å¤§æ–‡æœ¬æ—¶ä¿æŒé«˜æ•ˆä¸è¿…é€Ÿç›¸åº”çš„è¯æ›´æ˜¯å¦‚æ­¤<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="zi-fu-chuan-de-wen-ti"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#zi-fu-chuan-de-wen-ti">å­—ç¬¦ä¸²çš„é—®é¢˜</a></h1>
      <p>String é€šå¸¸ä¼šåˆ†é…ä¸ºè¿ç»­çš„å†…å­˜å—, è¿™å¯èƒ½å¯¼è‡´ç¼–è¾‘æ•ˆç‡å˜å¾—ä½ä¸‹<br><br>å‡è®¾æœ‰ä¸€ä¸ªå­˜å‚¨ç€ 20k è¡Œçš„å­—ç¬¦ä¸², ä½ æƒ³åœ¨è¯¥å­—ç¬¦ä¸²çš„ä¸­é—´æ’å…¥ä¸€ä¸ªå•è¯<br>ä¸ºæ­¤, ä½ å¿…é¡»åœ¨å­—ç¬¦ä¸²ä¸­é—´ä¸ºæ–°å•è¯è…¾å‡ºç©ºé—´, ä½¿å¾—æœ€åä»ç„¶èƒ½å¾—åˆ°ä¸€ä¸ªåˆ†é…ä¸ºè¿ç»­å†…å­˜å—çš„å­—ç¬¦ä¸²<br>è€Œä¸ºäº†è…¾å‡ºç©ºé—´, ä½ åˆå¿…é¡»ç§»åŠ¨æ–°æ’å…¥çš„å•è¯ä¹‹åçš„æ‰€æœ‰æ–‡æœ¬, ç§»åŠ¨æ„å‘³ç€ä¼šåˆ†é…å†…å­˜, æœ€åæƒ…å†µä¸‹å¿…é¡»ç§»åŠ¨æ‰€æœ‰å†…å®¹<br>å¯¹, æ‰€æœ‰çš„, æ‰€æœ‰çš„ 20k è¡Œ, ä»…ä»…æ˜¯ä¸ºäº†è…¾å‡ºå­˜å‚¨æ–°å•è¯éœ€è¦çš„ç©ºé—´<br><br>å†æ¯”å¦‚, å½“ä½ æƒ³åˆ é™¤ä¸€ä¸ªå•è¯æ—¶, ä½ ä¸èƒ½åªæ˜¯åœ¨å­—ç¬¦ä¸²ä¸Šæˆ³ä¸€ä¸ªæ´, å› ä¸ºè¿™æ„å‘³ç€å®ƒä¸å†æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²(è¿ç»­åˆ†é…çš„å†…å­˜å—)<br>ç›¸å, ä½ å¿…é¡»ç§»åŠ¨é™¤äº†å¾…åˆ é™¤å•è¯ä¹‹å¤–çš„æ‰€æœ‰å­—ç¬¦, ä½¿å¾—æœ€åä¼šå†æ¬¡å¾—åˆ°ä¸€ä¸ªå•ç‹¬çš„, è¿ç»­çš„, ä¸åŒ…æ‹¬åˆ é™¤å•è¯çš„å†…å­˜å—<br><br>å†å¤„ç†å°æ–‡æœ¬æ—¶è¿™äº›éƒ½ä¸æ˜¯é—®é¢˜, æˆ‘ä»¬æ¯å¤©éƒ½åœ¨åšç±»ä¼¼çš„æ“ä½œ, å¯¹å§? æ˜¯çš„, ä½†å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬è°ˆè®ºçš„æ˜¯è¾ƒå°çš„å­—ç¬¦ä¸²<br>å½“ä½ å¤„ç†å¤§æ–‡æœ¬æ—¶, æˆ–è€…è¿›è¡Œå¤§é‡ç¼–è¾‘æ—¶(ç”šè‡³å¯èƒ½: hello! multiple cursors!), è¿™äº›éƒ½ä¼šæˆä¸ºé—®é¢˜<br><br>æ³¨æ„, è¿™ç”šè‡³æ²¡æœ‰è§¦åŠæ–‡æœ¬ç¼–è¾‘å™¨å¯¹æ–‡æœ¬çš„è¡¨ç¤ºå¯èƒ½å…·æœ‰çš„æ‰€æœ‰å…¶ä»–è¦æ±‚<br><br>æ¯”å¦‚å¯¼èˆª(Navigation), å½“ç”¨æˆ·æƒ³è·³è½¬åˆ°ç¬¬ 523 è¡Œæ—¶, è¯¥æ€ä¹ˆåŠ?<br>å¦‚æœä½ æ‰‹ä¸Šåªæœ‰ä¸€ä¸ªè¡¨ç¤ºäº†è¿™äº›æ–‡æœ¬çš„å­—ç¬¦ä¸², åˆ™å¿…é¡»é€ä¸ªå­—ç¬¦è¿›è¡Œéå†, å¹¶è®¡ç®—å…¶ä¸­çš„æ¢è¡Œç¬¦, ä»¥æ‰¾å‡º â€œç¬¬523è¡Œâ€ çš„ä½ç½®<br>ç„¶å, å¦‚æœç”¨æˆ·æŒ‰å‘ä¸‹ç®­å¤´ 10 æ¬¡ä»¥å‘ä¸‹ç§»åŠ¨ 10 è¡Œ, å¹¶å¸Œæœ›æœ€ç»ˆå¤„äºåŒä¸€åˆ—, è¯¥æ€ä¹ˆåŠ?<br>ä½ å¿…é¡»å†æ¬¡å¼€å§‹è®¡ç®—å­—ç¬¦ä¸²ä¸­çš„æ¢è¡Œç¬¦, ç„¶åå†æœ€åä¸€ä¸ªæ¢è¡Œç¬¦åæ‰¾åˆ°æ­£ç¡®çš„åç§»é‡(offset), å¤„ç† â€œå¤„äºåŒä¸€åˆ—â€ çš„è¦æ±‚<br><br>å†æ¯”å¦‚, å‡è®¾ä½ æƒ³åœ¨ç¼–è¾‘å™¨çš„åº•éƒ¨ç»˜åˆ¶ä¸€ä¸ªæ°´å¹³æ»šåŠ¨æ¡, æƒ³çŸ¥é“æ»šåŠ¨æ»‘å—çš„å¤§å°ä»¥ä¾¿äºç»˜åˆ¶, ä½ å¿…é¡»çŸ¥é“æ–‡ä»¶ä¸­æœ€é•¿çš„ä¸€è¡Œæœ‰å¤šé•¿<br>åŒæ ·çš„äº‹æƒ…, ä½ å¿…é¡»éå†å­—ç¬¦ä¸²å¹¶è®¡ç®—è¡Œæ•°, è¿™æ¬¡è¿˜è¦è¿½è¸ªæ¯è¡Œçš„é•¿åº¦<br><br>æˆ–è€…å†æ¥ä¸ªä¾‹å­, å¦‚æœè¦åŠ è½½åˆ°ç¼–è¾‘å™¨ä¸­çš„æ–‡æœ¬æ–‡ä»¶å¤§äº 1GB, è€Œ æŸäº›è¯­è¨€ ç”¨æ¥å®ç°ç¼–è¾‘å™¨, æœ€å¤§åªèƒ½è¡¨ç¤º 1GB çš„å­—ç¬¦ä¸², è¯¥æ€ä¹ˆåŠ?<br><br>ä½ å¯èƒ½ä¼šè¯´, â€œ1GBçš„å­—ç¬¦ä¸²å¯¹æ¯ä¸ªäººæ¥è¯´éƒ½åº”è¯¥è¶³å¤Ÿäº†â€, ä½†è¿™åªèƒ½å‘Šè¯‰æˆ‘, ä½ è¿˜æ²¡æœ‰ä¸è¶³å¤Ÿå¤šçš„ç”¨æˆ·äº¤æµè¿‡<br>å“ˆ, å¼€ä¸ªç©ç¬‘è€Œå·², æˆ‘è®¤ä¸ºæˆ‘ä»¬å·²ç»ç¡®å®š, å­—ç¬¦ä¸²(String)å¹¶éåœ¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸­è¡¨ç¤ºæ–‡æœ¬çš„æœ€ä½³è§£å†³æ–¹æ¡ˆ<br><br>é‚£ä¹ˆæˆ‘ä»¬è¿˜èƒ½ç”¨ä»€ä¹ˆå‘¢?<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="bi-zi-fu-chuan-geng-hao-de-shi"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#bi-zi-fu-chuan-geng-hao-de-shi">æ¯”å­—ç¬¦ä¸²æ›´å¥½çš„æ˜¯?</a></h1>
      <p>å¦‚æœä½ çœŸçš„å¾ˆå–œæ¬¢å­—ç¬¦ä¸², ä½ å¯èƒ½ä¼šæƒ³, ç®€å•, multiple strings! å“¦, ä½ ç¦»ç­”æ¡ˆå¹¶éé‚£ä¹ˆè¿œ<br>ä¸€äº›ç¼–è¾‘å™¨ç¡®å®å°†æ–‡æœ¬è¡¨ç¤ºä¸ºè¡Œæ•°ç»„, æ¯è¡Œéƒ½ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ç¤º<br><br>vscode çš„ Monaco ç¼–è¾‘å™¨ä»¥è¿™ç§æ–¹å¼å·¥ä½œäº†å¾ˆé•¿ä¸€æ®µæ—¶é—´: <a class="underline underline-offset-5 font-medium" href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation#_previous-text-buffer-data-structure">previous-text-buffer-data-structure</a><br>ä½†å­—ç¬¦ä¸²æ•°ç»„ä»ç„¶ä¼šå—åˆ°ä¸å•ä¸ªå­—ç¬¦ä¸²ç›¸åŒé—®é¢˜çš„å›°æ‰°, è¿‡å¤šçš„å†…å­˜æ¶ˆè€—ä¸æ€§èƒ½é—®é¢˜è¿«ä½¿ vscode å›¢é˜Ÿå¯»æ‰¾æ›´å¥½çš„åŠæ³•<br><br>å¹¸è¿çš„æ˜¯, ç¡®å®å­˜åœ¨æ¯” String æ›´å¥½çš„ä¸œè¥¿<br>æ„å»ºæ–‡æœ¬ç¼–è¾‘å™¨çš„äººä»¬å¾ˆä¹…ä»¥å‰å°±æ„è¯†åˆ°å­—ç¬¦ä¸²å¹¶éå®Œæˆè¿™é¡¹å·¥ä½œçš„æœ€ä½³å·¥å…·, å¹¶æå‡ºäº†å…¶ä»–çš„æ•°æ®ç»“æ„æ¥è¡¨ç¤ºæ–‡æœ¬<br><br>æ®æˆ‘æ‰€çŸ¥, æœ€å—æ¬¢è¿çš„å‡ ä½æ˜¯: <a class="underline underline-offset-5 font-medium" href="https://en.wikipedia.org/wiki/Gap_buffer">gap buffer</a>, <a class="underline underline-offset-5 font-medium" href="https://en.wikipedia.org/wiki/Piece_table">piece table</a>, ä¸ <a class="underline underline-offset-5 font-medium" href="https://en.wikipedia.org/wiki/Rope_(data_structure)">rope</a><br><br>å®ƒä»¬å„æœ‰åˆ©å¼Š, æˆ‘å¹¶ä¸ä¼šåœ¨è¿™é‡Œè¯¦ç»†æ¯”è¾ƒå®ƒä»¬, çŸ¥é“å®ƒä»¬éƒ½æ˜æ˜¾ä¼˜äºå­—ç¬¦ä¸²å°±è¶³å¤Ÿäº†<br>ä¸åŒç¼–è¾‘å™¨åœ¨æƒè¡¡åˆ©å¼Šæ—¶åšå‡ºäº†ä¸åŒå†³å®š(ä¼˜åŒ–ä»¥æ›´é€‚åˆè‡ªå·±): <a class="underline underline-offset-5 font-medium" href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Buffer-Gap.html">emacs/gap-buffer</a>, <a class="underline underline-offset-5 font-medium" href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">vscode/piece-table</a>, <a class="underline underline-offset-5 font-medium" href="https://github.com/vim/vim/blob/master/src/memline.c#L15">vim/its-own-tree</a>, <a class="underline underline-offset-5 font-medium" href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">helix/rope</a><br><br>Zed ä¹Ÿä½¿ç”¨äº† rope, ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ¯”å­—ç¬¦ä¸²å¤šå‡ºäº†å“ªäº›ä¼˜åŠ¿<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="ropes"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#ropes">Ropes</a></h1>
      <p>ä»¥ä¸‹æ˜¯ ç»´åŸºç™¾ç§‘(Wikipedia) å¯¹ rope çš„å®šä¹‰ä¸è§£é‡Š:</p>
      <blockquote class="border-l-4 border-solid border-gray-300 mx-1 my-3 px-4 opacity-60">A rope is a type of binary tree where each leaf (end node) holds a string and a length (also known as a â€œweightâ€), and each node further up the tree holds the sum of the lengths of all the leaves in its left subtree.</blockquote>
      <blockquote class="border-l-4 border-solid border-gray-300 mx-1 my-3 px-4 opacity-60">rope æ˜¯ä¸€ç§äºŒå‰æ ‘, å…¶æ¯ä¸ªå¶å­èŠ‚ç‚¹åŒ…å«ä¸€ä¸ª string ä¸ä¸€ä¸ª length(ä¹Ÿè¢«å«ä½œ weight), æ ‘ä¸Šæ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«å…¶å·¦å­æ ‘ä¸­æ‰€æœ‰å¶å­çš„ length</blockquote>
      <p><br>rope å¹¶éè¿ç»­å†…å­˜å—, è€Œæ˜¯ä¸€æ£µæ ‘, å…¶å¶å­æ˜¯å®ƒæ‰€ä»£è¡¨çš„æ–‡æœ¬çš„å­—ç¬¦(characters)<br>ä»¥ä¸‹æ˜¯æ–‡æœ¬ â€œThis is a ropeâ€ åœ¨ rope ä¸­çš„æ ·å­:<br></p>
      <figure class="p-2 mb-2">
        <img class=" sm:w-[50%] mx-auto w-full rounded-lg" src="https://zed.dev/img/post/zed-decoded-rope-sumtree/rope.png">
        <figcaption class=" sm:w-[50%] mx-auto bg-[#212220] text-center w-full">A rope representing This is a rope</figcaption>
      </figure>
      <p>ä½ ç°åœ¨å¯èƒ½è®¤ä¸ºè¿™æ¯”å­—ç¬¦ä¸²è¦å¤æ‚å¾—å¤šâ€¦â€¦ä½ æ˜¯å¯¹çš„, ç¡®å®å¦‚æ­¤<br>ä½†åœ¨è®¸å¤šæƒ…å†µä¸‹, rope å­˜åœ¨ä¸€ä¸ªæˆ˜èƒœ string çš„å…³é”®éƒ¨åˆ†: å¶å­èŠ‚ç‚¹(leaves), æ¯”å¦‚ â€œThisâ€, â€œ is â€œ, â€œa â€œ, â€œropeâ€ åŸºæœ¬æ˜¯ä¸å¯å˜çš„<br><br>ä½ ä¸æ˜¯ä¿®æ”¹å­—ç¬¦ä¸², è€Œæ˜¯ä¿®æ”¹æ ‘, æ— éœ€åœ¨å­—ç¬¦ä¸²ä¸­æˆ³å­”å¹¶åœ¨å†…å­˜ä¸­ç§»åŠ¨å®ƒçš„ä¸€éƒ¨åˆ†, è€Œæ˜¯ä¿®æ”¹æ ‘ä»¥è·å–æ–°å­—ç¬¦ä¸²<br>åˆ°ç›®å‰ä¸ºæ­¢, ä½œä¸ºç¨‹åºå‘˜, æˆ‘ä»¬å·²ç»å¼„æ¸…æ¥šäº†å¦‚ä½•æœ‰æ•ˆåœ°åˆ©ç”¨æ ‘<br><br>è®©æˆ‘ä»¬å†æ¬¡å›åˆ°ä¸Šé¢çš„ä¾‹å­: åˆ é™¤æ–‡æœ¬ä¸­æŸä¸ªä½ç½®çš„å•è¯<br>ä½¿ç”¨ string æ—¶, æˆ‘ä»¬å¿…é¡»é‡æ–°åˆ†é…å•è¯åé¢çš„æ‰€æœ‰æ–‡æœ¬(å¯èƒ½æ˜¯æ•´ä¸ªå­—ç¬¦ä¸²)<br><br>ä½¿ç”¨ rope æ—¶, æ‰¾åˆ°è¦åˆ é™¤çš„å•è¯çš„å¼€å§‹ä¸ç»“æŸä½ç½®, ç„¶ååœ¨è¿™ä¸¤ä¸ªä½ç½®æ‹†åˆ†æ ‘, è¿™æ ·å°±æœ‰å››æ£µæ ‘<br>æ‰”æ‰ä¸­é—´çš„ä¸¤é¢—(åªåŒ…å«å¾…åˆ é™¤çš„å•è¯), è¿æ¥å¦å¤–ä¸¤é¢—æ ‘, ç„¶åé‡æ–°å¹³è¡¡æ ‘<br><br>æ˜¯çš„, è¿™å¬èµ·æ¥ç¡®å®å¾ˆéº»çƒ¦, ä¸”ç¡®å®éœ€è¦åœ¨åå°è¿›è¡Œä¸€äº›ç®—æ³•å¤„ç†, ä½†ä¸å­—ç¬¦ä¸²ç›¸æ¯”, å†…å­˜ä¸æ€§èƒ½çš„æ”¹è¿›ä¼šéå¸¸æ˜æ˜¾<br>æˆ‘ä»¬æ— éœ€åœ¨å†…å­˜ä¸­ç§»åŠ¨å†…å®¹, åªéœ€è¦æ›´æ–°å‡ ä¸ªæŒ‡é’ˆ, å¯¹äºåƒ â€œThis is a ropeâ€ è¿™æ ·çš„çŸ­æ–‡æœ¬æ¥è¯´æœ‰ç‚¹æ„šè ¢, ä½†å½“æ–‡æœ¬å¾ˆå¤§æ—¶ä¼šèŠ‚çœå¾ˆå¤šæ—¶é—´<br><br>è¿™å¬èµ·æ¥æœ‰ç‚¹æŠ½è±¡, æ‰€ä»¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹ Zed æ˜¯å¦‚ä½•å®ç° rope çš„<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="zedde-shi-xian"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#zedde-shi-xian">Zedçš„å®ç°</a></h1>
      <p>Zed åœ¨è‡ªå·±çš„ crate ä¸­æœ‰è‡ªå·±çš„å®ç°: <a class="underline underline-offset-5 font-medium" href="https://github.com/zed-industries/zed/tree/ae3c641bbee2029fb4588d008e45ddb783593622/crates/rope">rope</a><br>(è‡ªå·±å®ç°è€Œä¸æ˜¯ä½¿ç”¨åº“çš„åŸå› ä¹‹ä¸€æ˜¯, å½“åˆ›å§‹äººä»¬åœ¨ 2017 å¹´ä¸º Zed å¥ å®šåŸºç¡€æ—¶æœ‰å¾ˆå¤šåº“ä¸å­˜åœ¨)<br><br>åœ¨ rope è¿™ä¸ªåº“ä¸­çš„ä¸»è¦ç±»å‹æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code>, ä»¥ä¸‹æ˜¯ä½¿ç”¨æ–¹æ³•:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">let mut rope = Rope::new();
rope.push("Hello World! This is your captain speaking.");</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>åˆ°ç›®å‰ä¸ºæ­¢, å®ƒä¸ <code class="font-semibold text-[#aa8bd5]"><code>String</code></code> éå¸¸ç›¸ä¼¼, ç°åœ¨å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code>:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">let mut rope1 = Rope::new();
rope1.push("Hello World!");
 
let mut rope2 = Rope::new();
rope2.push("This is your captain speaking.");</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å¦‚æœæˆ‘ä»¬æƒ³è¿æ¥å®ƒä»¬, æˆ‘ä»¬è¦åšçš„æ˜¯:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">rope1.append(rope2);
 
assert_eq!(
    rope1.text(),
    "Hello World! This is your captain speaking.".to_string()
);</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å¯¹ <code class="font-semibold text-[#aa8bd5]"><code>rope1.append</code></code> çš„è°ƒç”¨é€šè¿‡æ„å»ºåŒ…å«è¿™ä¸¤é¢—æ ‘çš„æ–°æ ‘æ¥è¿›è¡Œè¿æ¥, è¿™åªä¸è¿‡æ˜¯æ›´æ–°äº†å‡ ä¸ªæŒ‡é’ˆè€Œå·²<br>å°†å…¶ä¸å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ, å¦‚æœä½ è¿æ¥ä¸¤ä¸ªå­—ç¬¦ä¸², åˆ™å¿…é¡»åœ¨å†…å­˜ä¸­ç§»åŠ¨å…¶ä¸­è‡³å°‘ä¸€ä¸ª, ä»¥ä¾¿äºå½¢æˆä¸€ä¸ªè¿ç»­çš„å—<br>é€šå¸¸ä½ å¿…é¡»ç§»åŠ¨å®ƒä»¬, å› ä¸ºç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ä¹‹åæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´<br>åŒæ ·, è¿™ä¸ªä¾‹å­ä¸­çš„æ–‡æœ¬çŸ­å¾—ä»¤äººå‘ç¬‘, å¦‚æœæœ‰äººæƒ³åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­æ‹¥æœ‰ 25k è¡Œ <a class="underline underline-offset-5 font-medium" href="https://sqlite.org/amalgamation.html">SQLite amalgamation</a> çš„ 10 ä»½å‰¯æœ¬è¯¥æ€ä¹ˆåŠ?<br><br>ç°åœ¨å†çœ‹çœ‹å¦‚ä½•æ›¿æ¢ä¸€ä¸ªå•è¯:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// Construct a rope
let mut rope = Rope::new();
rope.push("One coffee, please. Black, yes.");
 
// Replace characters 4 to 10 (0-indexed) with "guinness".
rope.replace(4..10, "guinness");
assert_eq!(rope.text(), "One guinness, please. Black, yes.");</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>åœ¨å¹•åå‘ç”Ÿäº†:<br></p>
      <ul class="list-disc ml-5">
        <li><code class="font-semibold text-[#aa8bd5]"><code>replace()</code></code> é¦–å…ˆå°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ rope, å®ƒåŒ…å«äº†åŸå…ˆ rope ç¬¬ 5 ä¸ªå­—ç¬¦(c)ä¹‹å‰çš„æ‰€æœ‰èŠ‚ç‚¹</li>
        <li>æ–°çš„æ–‡æœ¬ <code class="font-semibold text-[#aa8bd5]"><code>guinness</code></code> è¢« appended åˆ°äº†æ–°çš„ rope ä¸Š</li>
        <li>åŸå…ˆ rope çš„å‰©ä¸‹éƒ¨åˆ†(ç¬¬ 11 ä¸ªå­—ç¬¦ä¹‹åçš„æ‰€æœ‰å†…å®¹), å°†ä¼šè¢« appended åˆ°æ–°çš„ rope ä¸Š</li>
      </ul>
      <p>åˆ é™¤å•è¯? åªéœ€å°†å‚æ•°æ›´æ”¹ä¸ºç©ºå­—ç¬¦ä¸²:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">let mut rope = Rope::new();
rope.push("One coffee, please. Black, yes.");
rope.replace(4..10, "");</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å³ä½¿åœ¨å¤„ç†å¤§é‡æ–‡æœ¬æ—¶, è¿™äº›æ“ä½œä¹Ÿéå¸¸å¿«é€Ÿ, å› ä¸ºæ ‘ä¸­çš„å¤§å¤šæ•°èŠ‚ç‚¹éƒ½å¯ä»¥é‡ç”¨, åªéœ€è¦é‡æ–°è¿èµ·æ¥(rewired)å³å¯<br>ä½†å¯¹äºè¢«åˆ é™¤çš„å•è¯ â€œcoffeeâ€ ä¼šæ€ä¹ˆæ ·å‘¢? ä¸€æ—¦æ²¡æœ‰å…¶ä»–èŠ‚ç‚¹å†å¼•ç”¨(reference)è¿™äº›å­—ç¬¦, åŒ…å«è¿™äº›å­—ç¬¦çš„å¶èŠ‚ç‚¹å°±ä¼šè¢«è‡ªåŠ¨æ¸…ç†<br>è¿™å°±æ˜¯ rope ä¸­ä¸å¯å˜çš„å¶å­èŠ‚ç‚¹çš„ä½œç”¨: å½“ä¸€ä¸ª rope è¢«æ”¹å˜, æˆ–ä»æ—§çš„æ„é€ æ–°çš„, æˆ–åˆå¹¶ä¸¤ä¸ª rope æ—¶, æœ¬è´¨æ”¹å˜çš„éƒ½æ˜¯å¯¹å¶èŠ‚ç‚¹çš„å¼•ç”¨<br>å¹¶ä¸”è¿™äº›å¼•ç”¨ä¼šè¢«è®¡æ•°: ä¸€æ—¦æŸä¸ªèŠ‚ç‚¹ä¸å†è¢«å¼•ç”¨, å®ƒå°±ä¼šè¢«æ¸…ç†<br><br>å†å‡†ç¡®ç‚¹, ä»æŠ€æœ¯ä¸Šæ¥è®²: å¶èŠ‚ç‚¹. å³åŒ…å«å®é™…æ–‡æœ¬çš„èŠ‚ç‚¹, åœ¨ zed çš„ rope å®ç°ä¸­å¹¶ä¸æ˜¯å®Œå…¨ä¸å¯å˜çš„<br>èŠ‚ç‚¹å…·æœ‰æœ€å¤§é•¿åº¦, å½“è¶³å¤ŸçŸ­çš„æ–‡æœ¬å°†è¢«æ·»åŠ åˆ°æœ€åçš„å¶èŠ‚ç‚¹æ—¶, è‹¥æ·»åŠ åä»ä¸è¶…å‡ºå…¶æœ€å¤§é•¿åº¦, åˆ™èŠ‚ç‚¹å°±è‡ªç„¶ä¼šè¢«æ›´æ”¹, ç›´æ¥å°†æ–‡æœ¬æ·»åŠ åˆ°å…¶ä¸­<br><br>ä¸è¿‡, ä»æ¦‚å¿µå±‚é¢ä¸Šæ¥è®², ä½ å¯ä»¥å°† rope è§†ä½œ æŒä¹…æ•°æ®ç»“æ„, ä¸”å°†å…¶èŠ‚ç‚¹è§†ä½œæ ‘ä¸­å¼•ç”¨è®¡æ•°çš„ä¸å¯å˜èŠ‚ç‚¹<br>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒæ¯”å­—ç¬¦ä¸²å¥½çš„åŸå› , å¹¶è®©æˆ‘ä»¬å›åˆ°ä¸Šé¢è·³è¿‡çš„ä¸€ä¸ªé—®é¢˜: ä¸ºä»€ä¹ˆ Zed é€‰æ‹© rope è€Œä¸æ˜¯å…¶ä»–æ•°æ®ç»“æ„?<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="wei-he-zedshi-yong-rope"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#wei-he-zedshi-yong-rope">ä¸ºä½•Zedä½¿ç”¨rope?</a></h1>
      <p>Zed çš„ç›®æ ‡æ˜¯æˆä¸ºé«˜æ€§èƒ½çš„ä»£ç ç¼–è¾‘å™¨<br>å¦‚æˆ‘ä»¬æ‰€è§, å­—ç¬¦ä¸²ä¸ä¼šè·å¾—é«˜æ€§èƒ½, é‚£ä¹ˆç”¨ä»€ä¹ˆæ¥æ›¿ä»£å‘¢? gap-buffer? piece-table? rope?<br><br>è¿™é‡Œæ²¡æœ‰ä¸€ä¸ªæ˜æ˜¾ä¼˜äºå…¶ä»–çš„æœ€ä½³æœ€å¥½çš„æ–¹æ¡ˆ, è¿™ä¸€åˆ‡éƒ½å–å†³äºå…·ä½“éœ€æ±‚ä»¥åŠä½ æ„¿æ„ä¸ºæ»¡è¶³è¿™äº›éœ€æ±‚åšå‡ºçš„æƒè¡¡<br>ä¹Ÿè®¸ä½ å¬è¯´è¿‡ gap-buffer æ¯” rope æ›´å¿«æ›´å®¹æ˜“ç†è§£, äº¦æˆ–è€… piece-table æ›´åŠ ä¼˜é›…â€¦â€¦ è¿™å¯èƒ½æ˜¯çœŸçš„, æ˜¯çš„, ä½†è¿™ä»ç„¶ä¸æ„å‘³ç€å®ƒä»¬æ˜¯æ‰€è°“çš„ â€œæ˜æ˜¾çš„æœ€ä½³æ–¹æ¡ˆâ€<br><br>ä¸‹é¢æ˜¯ <a class="underline underline-offset-5 font-medium" href="https://github.com/cessen/ropey">ropey</a>(rust ä¸­æµè¡Œçš„ rope å®ç°)çš„ä½œè€…å†™çš„, å…³äº rope ä¸ gap-buffer é—´çš„<a class="underline underline-offset-5 font-medium" href="https://github.com/emacs-ng/emacs-ng/issues/378#issuecomment-907680382">æ€§èƒ½æƒè¡¡</a>:<br></p>
      <blockquote class="border-l-4 border-solid border-gray-300 mx-1 my-3 px-4 opacity-60">Ropes make a different performance trade-off, being a sort of â€œjack of all tradesâ€. Theyâ€™re not amazing at anything, but theyâ€™re always solidly good with O(log N) performance. Theyâ€™re not the best choice for an editor that only supports local editing patterns, since they leave a lot of performance on the table compared to gap buffers in that case (again, even for huge documents). But for an editor that encourages non-localized edits, or just wants flexibility in that regard, theyâ€™re a great choice because they always have good performance, whereas gap buffers degrade poorly with unfavorable editing patterns.</blockquote>
      <blockquote class="border-l-4 border-solid border-gray-300 mx-1 my-3 px-4 opacity-60">rope æ˜¯ä¸€ç§åœ¨æ€§èƒ½ä¸Šåšå‡ºäº†ä¸åŒæƒè¡¡çš„ â€œä¸‡äº‹é€šâ€. å®ƒä»¬åœ¨ä»»ä½•äº‹æƒ…ä¸Šéƒ½æ— æ³•è¾¾åˆ° â€œä»¤äººæƒŠå¹â€ çš„ç¨‹åº¦, ä½†æ€»æ˜¯å…·æœ‰ O(log N)çš„è‰¯å¥½æ€§èƒ½. å¯¹äºä»…æ”¯æŒæœ¬åœ°ç¼–è¾‘æ¨¡å¼çš„ç¼–è¾‘å™¨æ¥è¯´, å…¶å¹¶éæœ€ä½³é€‰æ‹©, å› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ç›¸æ¯” gap-buffer ä¼šé™ä½è®¸å¤šæ€§èƒ½(å³ä½¿æ˜¯å¤§å‹æ–‡æ¡£). ä½†å¯¹äºé¼“åŠ±éæœ¬åœ°åŒ–ç¼–è¾‘æˆ–åªæ˜¯å¸Œæœ›åœ¨è¿™æ–¹é¢å…·æœ‰çµæ´»æ€§çš„ç¼–è¾‘å™¨æ¥è®², rope æ˜¯ä¸ªå¾ˆå¥½çš„é€‰æ‹©, å› ä¸ºå®ƒä»¬å§‹ç»ˆå…·æœ‰è‰¯å¥½çš„æ€§èƒ½, è€Œ gap-buffer åœ¨ç¼–è¾‘æ¨¡å¼ä¸åˆ©çš„æƒ…å†µä¸‹, æ€§èƒ½ä¸‹é™ä¼šéå¸¸ç³Ÿç³•</blockquote>
      <p>ç®€å•æ¥è¯´, ropeåœ¨ä»»ä½•äº‹æƒ…ä¸Šéƒ½æ— æ³•è¾¾åˆ°ä»¤äººæƒŠå¹çš„ç¨‹åº¦, ä½†æ€»ä½“æ¥è¯´è¿˜æ˜¯å¾ˆä¸é”™çš„, è¿™å–å†³äºä½ æƒ³åšä»€ä¹ˆ, æˆ–è€…å¸Œæœ›ä½ çš„ç¼–è¾‘å™¨èƒ½å¤Ÿåšä»€ä¹ˆ<br>æ¯”å¦‚, å¦‚æœä½ çœŸçš„æƒ³åˆ©ç”¨ CPU ä¸­çš„æ‰€æœ‰å†…æ ¸æ€ä¹ˆåŠ? åœ¨ <a class="underline underline-offset-5 font-medium" href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text showdown: Gap Buffers vs Ropes</a> ä¸­, æœ«å°¾æåˆ°äº†å¹¶å‘æ€§:<br></p>
      <blockquote class="border-l-4 border-solid border-gray-300 mx-1 my-3 px-4 opacity-60">Ropes have other benefits besides good performance. Both Crop and Ropey [note: both are rope implementations in Rust] support concurrent access from multiple threads. This lets you take snapshots to do asynchronous saves, backups, or multi-user edits. This isnâ€™t something you could easily do with a gap buffer.</blockquote>
      <blockquote class="border-l-4 border-solid border-gray-300 mx-1 my-3 px-4 opacity-60">é™¤äº†æ€§èƒ½è‰¯å¥½, rope è¿˜æœ‰å…¶ä»–å¥½å¤„. æ— è®ºæ˜¯ crop è¿˜æ˜¯ ropey(ä¸¤è€…éƒ½æ˜¯ rust ä¸­æµè¡Œçš„å®ç°) éƒ½æ”¯æŒæ¥è‡ªå¤šä¸ªçº¿ç¨‹çš„å¹¶å‘è®¿é—®. è¿™å…è®¸ä½ è¿›è¡Œå¿«ç…§ä»¥ä¾¿äºæ‰§è¡Œå¼‚æ­¥ä¿å­˜, å¤‡ä»½, æˆ–è€…å¤šç”¨æˆ·ç¼–è¾‘. è¿™ä¸æ˜¯ä½ å¯ä»¥ç”¨ gap-buffer è½»æ¾å®Œæˆçš„äº‹æƒ…</blockquote>
      <p>åœ¨æˆ‘ä»¬çš„ <a class="underline underline-offset-5 font-medium" href="https://youtu.be/uUu9eFNNbjg">é…å¥—è§†é¢‘</a> ä¸­, ä½ å¯ä»¥å¬åˆ° Max å¯¹è¿™ä¸€æ®µçš„è¯„ä»·: â€œç¡®å®, è¿™æ¯”å…¶ä»–ä»»ä½•äº‹éƒ½é‡è¦â€<br>å…¶ä¸­, â€œè¿™â€ æŒ‡çš„å°±æ˜¯å¹¶å‘è®¿é—®, å¿«ç…§, å¤šç”¨æˆ·ç¼–è¾‘, å¼‚æ­¥æ“ä½œ<br><br>æ¢å¥è¯è¯´, å¹¶å‘è®¿é—® buffer çš„æ–‡æœ¬æ˜¯ Zed çš„ç¡¬æ€§è¦æ±‚, è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ rope æœ€ç»ˆæˆä¸ºé¦–é€‰çš„åŸå› <br><br>ä¸‹é¢æ˜¯ä¸€ä¸ªå®ä¾‹, è¯´æ˜å¯¹æ–‡æœ¬çš„å¹¶å‘è®¿é—®åœ¨ Zed ä¸­æ ¹æ·±è’‚å›º:<br>å½“ä½ åœ¨ Zed ä¸­ç¼–è¾‘ buffer ä¸­çš„æ–‡æœ¬ä¸”å¯ç”¨äº†è¯­æ³•é«˜äº®æ—¶, buffer ä¸­æ–‡æœ¬å†…å®¹çš„å¿«ç…§(snapshot)å°†ä¼šå‘é€åˆ°åå°çº¿ç¨‹<br>åœ¨è¯¥çº¿ç¨‹ä¸­, ä½¿ç”¨ <a class="underline underline-offset-5 font-medium" href="https://tree-sitter.github.io/tree-sitter/">tree-sitter</a> é‡æ–°è§£æ<br>æ¯æ¬¡ç¼–è¾‘éƒ½ä¼šå‘ç”Ÿ, è€Œä¸”éå¸¸éå¸¸éå¸¸å¿«é€Ÿé«˜æ•ˆ, å› ä¸ºå¿«ç…§ä¸éœ€è¦æ–‡æœ¬çš„å®Œæ•´å‰¯æœ¬, æ‰€éœ€è¦çš„ä»…ä»…æ˜¯å¢åŠ å¼•ç”¨è®¡æ•°è€Œå·²<br>å› ä¸º Zed ä¸­ rope èŠ‚ç‚¹çš„å¼•ç”¨è®¡æ•°æ˜¯é€šè¿‡ Arc å®ç°çš„, Arc æ˜¯ rust ä¸­çš„ â€œçº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°æŒ‡é’ˆâ€<br><br>è¿™å°±å¼•å‡ºäº†æœ€é‡è¦çš„ä¸€ç‚¹: Zed ä¸­å¯¹ rope çš„å…·ä½“å®ç°<br>å› ä¸ºå…¶å®ç°å¹¶ä¸åƒä½ åœ¨ wiki ä¸Šçœ‹è§çš„ç»å…¸ rope é‚£æ ·, è¯¥å®ç°ä¹Ÿä¸º Zed ä¸­çš„ rope æä¾›äº†å…¶ä»– rope å¯èƒ½æ²¡æœ‰çš„æŸäº›å±æ€§<br>è€Œè¿™ç§å®ç°, å®é™…ä¸Šæ˜¯ä½¿ rope ä¼˜å…ˆäºå…¶ä»–æ•°æ®ç»“æ„çš„åŸå› <br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="yin-ru-sumtree"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#yin-ru-sumtree">å¼•å…¥SumTree</a></h1>
      <p>Zed ä¸­çš„ rope ä¸æ˜¯ç»å…¸çš„äºŒå‰æ ‘å½¢å¼çš„ rope, è€Œæ˜¯ä¸€ä¸ª sumtree<br>å½“ä½ æ‰“å¼€ Zed ä¸­å…³äº <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code> çš„å®šä¹‰, ä½ ä¼šå‘ç°å®ƒåªä¸è¿‡æ˜¯ç”±ä¸€å † <code class="font-semibold text-[#aa8bd5]"><code>Chunk</code></code> ç»„æˆçš„ <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code>:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">struct Rope {
    chunks: SumTree&lt;Chunk>,
}
 
struct Chunk(ArrayString&lt;{ 2 * CHUNK_BASE }>);</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p><code class="font-semibold text-[#aa8bd5]"><code>Chunk</code></code> æ˜¯ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>ArrayString</code></code>, åè€…æ¥è‡ªäº <a class="underline underline-offset-5 font-medium" href="https://docs.rs/arrayvec/latest/arrayvec/">arrayvec</a>), å…è®¸å†…è”å­˜å‚¨ String, è€Œä¸æ˜¯å­˜å‚¨åœ¨å †çš„å…¶ä»–åœ°æ–¹<br>å«ä¹‰: <code class="font-semibold text-[#aa8bd5]"><code>Chunk</code></code> æ˜¯ä¸€å †å­—ç¬¦çš„é›†åˆ, chunks åˆ™æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> ä¸­çš„å¶å­, å…¶æœ€å¤šåŒ…å« <code class="font-semibold text-[#aa8bd5]"><code>2 * CHUNK_BASE</code></code> ä¸ªå­—ç¬¦<br>(åœ¨ Zed çš„å‘å¸ƒç‰ˆæœ¬ä¸Š, <code class="font-semibold text-[#aa8bd5]"><code>CHUNK_BASE</code></code> è¢«å®šä¹‰ä¸º <code class="font-semibold text-[#aa8bd5]"><code>64</code></code>)<br><br>é‚£ä¹ˆä»€ä¹ˆæ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> å‘¢? å½“è¯¢é—® Nathan æ—¶, ä»–å›ç­”é“: â€œSumTree æ˜¯ Zed çš„çµé­‚â€<br>å½“ç„¶, å¯¹ <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> çš„æŠ€æœ¯æè¿°æ˜¯è¿™æ ·çš„:<br><br><code class="font-semibold text-[#aa8bd5]"><code>SumTree&lt;T></code></code> æ˜¯ä¸€ä¸ª B+ æ ‘<br>å…¶æ¯ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Leaf</code></code> èŠ‚ç‚¹éƒ½åŒ…å«å¤šä¸ªç±»å‹ä¸º T çš„é¡¹(item), æ¯ä¸ªé¡¹éƒ½å«æœ‰ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Summary</code></code><br>å…¶æ¯ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Internal</code></code> èŠ‚ç‚¹éƒ½å«æœ‰å¯¹äºå…¶å­æ ‘ä¸­çš„é¡¹çš„ <code class="font-semibold text-[#aa8bd5]"><code>Summary</code></code><br><br>ä»¥ä¸‹æ˜¯åŒ¹é…çš„ç±»å‹å®šä¹‰, ä½ èƒ½åœ¨ <a class="underline underline-offset-5 font-medium" href="https://github.com/zed-industries/zed/blob/6721c91ab000cea73ab30209c4a57bd1e2e2ce56/crates/sum_tree/src/sum_tree.rs">sum_tree</a> è¿™ä¸ª crate ä¸­æ‰¾åˆ°å®ƒä»¬:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">//  crates/sum_tree/src/sum_tree.rs 
struct SumTree&lt;T: Item>(pub Arc&lt;Node&lt;T>>);
 
enum Node&lt;T: Item> {
    Internal {
        height: u8,
        summary: T::Summary,
        child_summaries: ArrayVec&lt;T::Summary, { 2 * TREE_BASE }>,
        child_trees: ArrayVec&lt;SumTree&lt;T>, { 2 * TREE_BASE }>,
    },
    Leaf {
        summary: T::Summary,
        items: ArrayVec&lt;T, { 2 * TREE_BASE }>,
        item_summaries: ArrayVec&lt;T::Summary, { 2 * TREE_BASE }>,
    },
}
trait Item: Clone {
    type Summary: Summary;
 
    fn summary(&amp;self) -> Self::Summary;
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æ‰€ä»¥, åˆ°åº•ä»€ä¹ˆæ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>Summary</code></code>(æ‘˜è¦) å‘¢? å“ˆå“ˆ, æ˜¯ä½ æƒ³è¦çš„ä»»ä½•ä¸œè¥¿!<br>å”¯ä¸€çš„è¦æ±‚æ˜¯, ä½ éœ€è¦èƒ½å¤Ÿå°†å¤šä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Summary</code></code> æ·»åŠ åœ¨ä¸€èµ·, ä»¥åˆ›å»º â€œa sum of summariesâ€:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">trait Summary: Default + Clone + fmt::Debug {
    type Context;
 
    fn add_summary(&amp;mut self, summary: &amp;Self, cx: &amp;Self::Context);
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å“¦, æˆ‘çŸ¥é“ä½ è‚¯å®šå¯¹æˆ‘ç¿»äº†ä¸ªç™½çœ¼, æ‰€ä»¥è®©æˆ‘ä»¬æŠŠå®ƒè¯´å¾—å…·ä½“äº›<br>ç”±äº <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code> æ˜¯ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code>, å¹¶ä¸” <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> ä¸­çš„æ¯ä¸ªé¡¹éƒ½å¿…é¡»æœ‰ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Summary</code></code>, å› æ­¤ä»¥ä¸‹æ˜¯ä¸èŠ‚ç‚¹å…³è”çš„ <code class="font-semibold text-[#aa8bd5]"><code>Summary</code></code>:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">struct TextSummary {
    /// Length in UTF-8
    len: usize,
    /// Length in UTF-16 code units
    len_utf16: OffsetUtf16,
    /// A point representing the number of lines and the length of the last line
    lines: Point,
    /// How many `char`s are in the first line
    first_line_chars: u32,
    /// How many `char`s are in the last line
    last_line_chars: u32,
    /// How many UTF-16 code units are in the last line
    last_line_len_utf16: u32,
    /// The row idx of the longest row
    longest_row: u32,
    /// How many `char`s are in the longest row
    longest_row_chars: u32,
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p><code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹(<code class="font-semibold text-[#aa8bd5]"><code>Internal</code></code> &amp; <code class="font-semibold text-[#aa8bd5]"><code>Leaf</code></code>)éƒ½æœ‰è¿™æ ·çš„ <code class="font-semibold text-[#aa8bd5]"><code>Summary</code></code>, å…¶åŒ…å«äº†æœ‰å…³å…¶å­æ ‘çš„ä¿¡æ¯<br><code class="font-semibold text-[#aa8bd5]"><code>Leaf</code></code> èŠ‚ç‚¹å…·æœ‰ <code class="font-semibold text-[#aa8bd5]"><code>Chunk</code></code> çš„æ‘˜è¦, <code class="font-semibold text-[#aa8bd5]"><code>Internal</code></code> èŠ‚ç‚¹å…·æœ‰çš„æ‘˜è¦åˆ™æ˜¯å…¶å­èŠ‚ç‚¹çš„æ‘˜è¦çš„æ€»å’Œ(åœ¨æ ‘ä¸­é€’å½’å‘ä¸‹)<br><br>å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ 5 è¡Œæ–‡æœ¬:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-text text-sm sm:text-base">Hello World!
This is
your captain speaking.
Are you
ready for take-off?</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å¦‚æœå°†å…¶ push åˆ° Zed çš„ <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code> ä¸­, åˆ™ <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code> ä¸‹çš„ <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> å°†å¦‚ä¸‹æ˜¾ç¤º(ç®€åŒ–è¿‡):<br></p>
      <figure class="p-2 mb-2">
        <img class=" sm:w-[90%] mx-auto w-full rounded-lg" src="https://zed.dev/img/post/zed-decoded-rope-sumtree/sumtree_diagram.png">
        <figcaption class=" sm:w-[90%] mx-auto bg-[#212220] text-center w-full">A SumTree representing <code class="font-semibold text-[#aa8bd5]"><code>Hello World!\nThis is\nyour captain speaking.\nAre you\nready for take-off?\n</code></code> with some summary fields left out</figcaption>
      </figure>
      <p>æˆ‘çœç•¥äº† <code class="font-semibold text-[#aa8bd5]"><code>TextSummary</code></code> ä¸­çš„ä¸€äº›å­—æ®µ, ä»¥ä¿æŒå›¾ç‰‡è¾ƒå°, å¹¶ä¸”è°ƒæ•´äº† chunks çš„æœ€å¤§ç©ºé—´ä¸ æ¯ä¸ªå­èŠ‚ç‚¹çš„æœ€å¤§å­é¡¹æ•°é‡<br>(åœ¨ Zed çš„å‘å¸ƒç‰ˆæœ¬ä¸Š, è¯¥æ–‡æœ¬çš„å…¨éƒ¨äº”è¡Œé€‚åˆä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹)<br><br>å³ä½¿åªæœ‰ 3 ä¸ªæ‘˜è¦å­—æ®µ: <code class="font-semibold text-[#aa8bd5]"><code>len</code></code>, <code class="font-semibold text-[#aa8bd5]"><code>lines</code></code>, <code class="font-semibold text-[#aa8bd5]"><code>longest_row_chars</code></code>, æˆ‘ä»¬ä¹Ÿèƒ½çœ‹è§ <code class="font-semibold text-[#aa8bd5]"><code>Internal</code></code> èŠ‚ç‚¹çš„æ‘˜è¦æ˜¯å…¶å­èŠ‚ç‚¹çš„æ€»å’Œ<br>æ ¹èŠ‚ç‚¹èŠ‚ç‚¹çš„æ‘˜è¦å‘Šè¯‰æˆ‘ä»¬å®Œæ•´çš„æ–‡æœ¬, å®Œæ•´çš„ <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code> çš„ä¿¡æ¯: 72 ä¸ªå­—ç¬¦, 5 è¡Œ, æœ€é•¿è¡Œæœ‰ 22 ä¸ªå­—ç¬¦(â€œyour captain speaking.nâ€)<br>è€Œ <code class="font-semibold text-[#aa8bd5]"><code>Interenal</code></code> èŠ‚ç‚¹åˆ™å‘Šè¯‰æˆ‘ä»¬å…³äºæ–‡æœ¬çš„å„ä¸ªéƒ¨åˆ†çš„ä¿¡æ¯, æ¯”å¦‚å·¦ä¸‹çš„èŠ‚ç‚¹è¯´: â€œHellâ€ åˆ° â€œspeaâ€(åŒ…æ‹¬æ¢è¡Œç¬¦) æœ‰ 38 ä¸ªå­—ç¬¦, åŒ…æ‹¬ 2 ä¸ªæ¢è¡Œç¬¦<br><br>å¥½å§, ä½ å¯èƒ½ä¼šæƒ³, ä¸€ä¸ªæ‘˜è¦äº†æ‘˜è¦çš„ B+ æ ‘, è¿™ç»™æˆ‘ä»¬å¸¦æ¥äº†ä»€ä¹ˆ?<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="bian-li-sumtree"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#bian-li-sumtree">éå†SumTree</a></h1>
      <p><code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> æ˜¯ä¸€ä¸ªå¹¶å‘å‹å¥½çš„ Bæ ‘, ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæŒä¹…(persistent), å†™æ—¶å¤åˆ¶(copy-on-write)çš„æ•°æ®ç»“æ„å»è¡¨ç¤ºæ–‡æœ¬<br>åŒæ—¶, å®ƒè¿˜é€šè¿‡æ‘˜è¦æ¥ç´¢å¼•æ•°æ®, å…è®¸æ²¿ç€æ‘˜è¦çš„ç»´åº¦ä»¥ O(log n) çš„æ—¶é—´è¿›è¡Œéå†<br><br>ç”¨ Max çš„è¯æ¥è®², <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> åœ¨æ¦‚å¿µä¸Šå¹¶ä¸åƒä¸€ä¸ª map, è€Œæ›´åƒä¸€ä¸ªå…·æœ‰ç‰¹æ®Šç´¢å¼•åŠŸèƒ½çš„ <code class="font-semibold text-[#aa8bd5]"><code>Vec</code></code><br>ä½ å¯ä»¥åœ¨å…¶ä¸­å­˜å‚¨ä»»ä½•æ‰€éœ€çš„ item çš„åºåˆ—, ä½ å†³å®šé¡ºåº, è€Œå®ƒæä¾›æŸ¥æ‰¾ä¸åˆ‡ç‰‡çš„åŠŸèƒ½<br><br><code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> ä¸­çš„ item æ˜¯æœ‰åºçš„, å®ƒä»¬çš„æ‘˜è¦ä¹Ÿè¢«æ’åº<br><code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> å…è®¸ä½ åœ¨ O(log N) çš„æ—¶é—´å†…æ‰¾åˆ°æ ‘ä¸­çš„ä»»ä½• item, æ–¹æ³•æ˜¯ä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†, æ ¹æ®èŠ‚ç‚¹çš„æ‘˜è¦å†³å®šè®¿é—®å“ªä¸ªèŠ‚ç‚¹<br><br>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code>, é‡Œé¢æœ‰ 3 è¡Œæ–‡æœ¬:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">let mut rope = Rope::new();
rope.push("Line one.\n");
rope.push("This is the second line.\n");
rope.push("This is three.\n");</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æ„é€ çš„ <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code> çœ‹èµ·æ¥åƒè¿™æ ·:<br></p>
      <figure class="p-2 mb-2">
        <img class=" sm:w-[90%] mx-auto w-full rounded-lg" src="https://zed.dev/img/post/zed-decoded-rope-sumtree/sumtree_three_lines.png">
        <figcaption class=" sm:w-[90%] mx-auto bg-[#212220] text-center w-full">A SumTree representing <code class="font-semibold text-[#aa8bd5]"><code>Line one.\nThis is the second line.\nThis is three.\n</code></code> with some summary fields left out</figcaption>
      </figure>
      <p>æ­£å¦‚æˆ‘ä»¬ä¸Šé¢æ‰€è¯´: æ¯ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Leaf</code></code> èŠ‚ç‚¹å…·æœ‰å¤šä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Chunk</code></code>, ä¸”å…¶æ‘˜è¦å«æœ‰æœ‰å…³ <code class="font-semibold text-[#aa8bd5]"><code>Chunk</code></code> ä¸­æ–‡æœ¬çš„ä¿¡æ¯<br>è¯¥æ‘˜è¦çš„ç±»å‹æ˜¯ä¸Šé¢çš„ <code class="font-semibold text-[#aa8bd5]"><code>TextSummary</code></code>, èƒ½å‘ŠçŸ¥å…¶ chunks ä¸­æ–‡æœ¬çš„é•¿åº¦, è¡Œæ•°, æœ€é•¿çš„è¡Œ, ä»¥åŠå…¶ä»–æ‰€æœ‰å¤„äº <code class="font-semibold text-[#aa8bd5]"><code>TextSummary</code></code> ä¸­çš„å­—æ®µ<br>éšå, <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> ä¸­çš„ <code class="font-semibold text-[#aa8bd5]"><code>Intrnal</code></code> èŠ‚ç‚¹å«æœ‰æ‘˜è¦çš„æ‘˜è¦<br><br>ç”±äºæ ‘ä¸­çš„é¡¹(<code class="font-semibold text-[#aa8bd5]"><code>Internal</code></code> èŠ‚ç‚¹, <code class="font-semibold text-[#aa8bd5]"><code>Leaf</code></code> èŠ‚ç‚¹, <code class="font-semibold text-[#aa8bd5]"><code>Chunks</code></code>) æ˜¯æœ‰åºçš„, æˆ‘ä»¬å¯ä»¥éå¸¸é«˜æ•ˆåœ°éå†è¯¥æ ‘, å› ä¸ºæˆ‘ä»¬å¯ä»¥æ ¹æ®æ‘˜è¦ä¸­çš„å€¼è¿›è¡Œéå†<br>å®ƒå…è®¸æˆ‘ä»¬æ²¿ç€å•ä¸ªç»´åº¦, æ¯”å¦‚ç»™å®šçš„æ‘˜è¦ä¸­çš„å­—æ®µ, è¿›è¡ŒæŸ¥æ‰¾<br><br>å‡è®¾æˆ‘ä»¬æƒ³çŸ¥é“æ ‘ä¸­ç»å¯¹åç§»é‡(absolute offset) 26 å¤„(ç¬¬26ä¸ªå­—ç¬¦)æ˜¯ä»€ä¹ˆ, å¯ä»¥æ²¿ç€ <code class="font-semibold text-[#aa8bd5]"><code>TextSummary</code></code> ä¸­ len å­—æ®µè¿›è¡Œéå†<br>(å› ä¸º len æ˜¯ä»å·¦åˆ°å³è¿›è¡Œå¢åŠ çš„, ä¹Ÿå°±æ˜¯ absolute offset)<br><br>å› æ­¤, ä¸ºäº†æ‰¾åˆ°è¿™ä¸ª absolute offset 26 çš„ä½ç½®, æˆ‘ä»¬éå†æ ‘, å–å†³äº <code class="font-semibold text-[#aa8bd5]"><code>Intrnal</code></code> èŠ‚ç‚¹çš„æ‘˜è¦å†³å®šå·¦å³æ–¹å‘, ç›´åˆ°æœ€ç»ˆåˆ°è¾¾æ»¡è¶³æ¡ä»¶çš„ <code class="font-semibold text-[#aa8bd5]"><code>Leaf</code></code> èŠ‚ç‚¹:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">let point = rope.offset_to_point(26);
assert_eq!(point.row, 1);
assert_eq!(point.column, 16);</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>ä»è¡¨é¢çœ‹, <code class="font-semibold text-[#aa8bd5]"><code>rope.offset_to_point(26)</code></code> å°†ä¸€ä¸ª absolute(0-based) çš„ offset(å³26), è½¬æ¢ä¸º <code class="font-semibold text-[#aa8bd5]"><code>Point</code></code> ç»“æ„ä½“, å…¶ç”± row(è¡Œ) ä¸ column(åˆ—)ç»„æˆ<br>è¯¥å‡½æ•°å†…éƒ¨å‘ç”Ÿçš„æƒ…å†µæ˜¯: cursor å°†éå†æ ‘, æ¯æ¬¡éå†éƒ½ç´¯è®¡ <code class="font-semibold text-[#aa8bd5]"><code>TextSummary</code></code> ä¸­çš„å­—æ®µ <code class="font-semibold text-[#aa8bd5]"><code>len</code></code>, ç›´åˆ°æ‰¾åˆ° <strong>>=26</strong> çš„é¡¹<br>ä¸€æ—¦æ‰¾åˆ°ç¬¬ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Leaf</code></code> èŠ‚ç‚¹, å°±ä¼šæ‰¾åˆ° offset åŒ¹é…çš„å…·ä½“ <code class="font-semibold text-[#aa8bd5]"><code>Chunk</code></code>, å¹¶å°† cursor åœåœ¨é‚£é‡Œ<br><br>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­, å®ƒä¸ä»…ä¸åœåœ°è®¡ç®—é‡åˆ°çš„æ‘˜è¦ä¸­çš„ <code class="font-semibold text-[#aa8bd5]"><code>len</code></code> å­—æ®µ, è¿˜ç´¯è®¡äº†åŒ…å« row ä¸ column çš„ <code class="font-semibold text-[#aa8bd5]"><code>lines</code></code> å­—æ®µ, å¾ˆæ•´æ´, å¯¹å§?<br>ä¸è¿‡åœ¨å®é™…ä»£ç ä¸­, è¿™æ˜¯ <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code> ä¸Šçš„ <code class="font-semibold text-[#aa8bd5]"><code>offset_to_point</code></code> æ–¹æ³•:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn offset_to_point(&amp;self, offset: usize) -> Point {
    if offset >= self.summary().len {
        return self.summary().lines;
    }
    let mut cursor = self.chunks.cursor::&lt;(usize, Point)>();
    cursor.seek(&amp;offset, Bias::Left, &amp;());
    let overshoot = offset - cursor.start().0;
    cursor.start().1
        + cursor
            .item()
            .map_or(Point::zero(), |chunk| chunk.offset_to_point(overshoot))
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>å…¶ä½œç”¨å¦‚ä¸‹:<br></p>
      <ul class="list-disc ml-5">
        <li>å¥å…¨æ€§æ£€æŸ¥, æ£€æŸ¥åç§»é‡æ˜¯å¦æœªè¶…è¿‡æ•´ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code> çš„è¡Œå°¾</li>
        <li>åˆ›å»ºä¸€ä¸ª cursor, æ²¿ç€ usize(offset) ä¸ Point(å…·æœ‰ä¸¤ä¸ªå­—æ®µ row ä¸ column çš„ç»“æ„ä½“) çš„ç»´åº¦è¿›è¡Œæœç´¢, å¹¶åœ¨æ‰§è¡Œæ“ä½œæ—¶åŒæ—¶ç´¯è®¡ä¸¤è€…</li>
        <li>ä¸€æ—¦å®ƒåœ¨ offset å¤„æ‰¾åˆ°äº†é¡¹, å°±ä¼šå¼€å§‹è®¡ç®— overshoot(è¿‡å†², ç”µå­å­¦ä¸ŠæŒ‡ä»ä¸€ä¸ªå€¼è½¬æ¢ä¸ºå¦ä¸€ä¸ªå€¼æ—¶, å‚æ•°çš„ç¬æ—¶å€¼è¶…è¿‡å…¶æœ€ç»ˆç¨³æ€çš„å€¼):</li>
      </ul>
      <p>æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾çš„ offset å¯èƒ½ä½äºå•ä¸ª chunk çš„ä¸­é—´, ä¸” <code class="font-semibold text-[#aa8bd5]"><code>cursor.start().0</code></code> æ˜¯ä¸€ä¸ª usize(offset), è¡¨ç¤ºç»™å®š chunk çš„èµ·å§‹ä½ç½®</p>
      <ul class="list-disc ml-5">
        <li>å–è¡Œæ•°è‡³å½“å‰ chunk çš„èµ·å§‹è¡Œ (<code class="font-semibold text-[#aa8bd5]"><code>cursor.start().1</code></code>, å³å…³äºå½“å‰é¡¹å·¦ä¾§çš„å®Œæ•´çš„æ ‘çš„ <code class="font-semibold text-[#aa8bd5]"><code>TextSummary.len</code></code> çš„æ‘˜è¦</li>
        <li>å°†å®ƒä»¬æ·»åŠ è‡³ offset (å¯èƒ½)ä½äº chunk ä¸­é—´éƒ¨åˆ†çš„è¡Œ (<code class="font-semibold text-[#aa8bd5]"><code>cursor.offset_to_point(overshoot)</code></code>)</li>
      </ul>
      <p><br>è¿™é‡Œæœ€æœ‰è¶£çš„åœ°æ–¹åœ¨äº <code class="font-semibold text-[#aa8bd5]"><code>self.chunks.cursor::&lt;usize, Point>()</code></code>, è¯¥ cursor å…·æœ‰ä¸¤ä¸ªç»´åº¦<br>å®ƒå…è®¸æ‚¨åœ¨ç»™å®šçš„ä¸€ä¸ªç»´åº¦(usize)ä¸ŠæŸ¥æ‰¾å€¼, å¹¶åœ¨åŒä¸€æ“ä½œä¸­, è·å–ç‰¹å®š cursor ä½ç½®çš„ç¬¬äºŒä¸ªç»´åº¦(Point)çš„æ€»å’Œ<br><br>è¿™æ ·çš„ç¾å¦™ä¹‹å¤„åœ¨äºå…¶å¯ä»¥åœ¨ O(log N) çš„æ—¶é—´å†…å®Œæˆæ­¤æ“ä½œ, å› ä¸ºæ¯ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Internal</code></code> èŠ‚ç‚¹éƒ½åŒ…å«æ‘˜è¦çš„æ‘˜è¦(æœ¬ä¾‹ä¸­ä¸ºæ‰€æœ‰å­é¡¹çš„æ€» <code class="font-semibold text-[#aa8bd5]"><code>len</code></code> )<br>å¹¶ä¸”å¯ä»¥è·³è¿‡ <code class="font-semibold text-[#aa8bd5]"><code>len &lt; 26</code></code> çš„æ‰€æœ‰é¡¹ (ä¸Šå›¾ä¸­, ç”šè‡³ä¸å¿…å»éå†å‰ä¸¤ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Leaf</code></code> èŠ‚ç‚¹)<br><br>è¿™ä¸æ˜¯å¾ˆç¥å¥‡å—? è¿˜æœ‰æ›´å¤š!<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="shi-yong-sumtree"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#shi-yong-sumtree">ä½¿ç”¨ SumTree</a></h1>
      <p>ä½ ä¹Ÿå¯ä»¥åè¿‡æ¥éå† <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code>, æ²¿ç€ lines/rows æŸ¥æ‰¾å¹¶è·å–æœ€ç»ˆçš„åç§»é‡:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">// Go from offset to point:
let point = rope.offset_to_point(55);
assert_eq!(point.row, 2);
assert_eq!(point.column, 6);
 
// Go from point to offset:
let offset = rope.point_to_offset(Point::new(2, 6));
assert_eq!(offset, 55);</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>è€Œä¸”, ä½ å¯èƒ½çŒœåˆ°äº†, <code class="font-semibold text-[#aa8bd5]"><code>point_to_offset</code></code> ä¸ <code class="font-semibold text-[#aa8bd5]"><code>offset_to_point</code></code> çœ‹èµ·æ¥ä¸€æ¨¡ä¸€æ ·, ä»…ä»…åªæ˜¯æ„é€  cursor çš„ç»´åº¦æ˜¯ç¿»è½¬çš„:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn point_to_offset(&amp;self, point: Point) -> usize {
    if point >= self.summary().lines {
        return self.summary().len;
    }
    let mut cursor = self.chunks.cursor::&lt;(Point, usize)>();
    cursor.seek(&amp;point, Bias::Left, &amp;());
    let overshoot = point - cursor.start().0;
    cursor.start().1
        + cursor
            .item()
            .map_or(0, |chunk| chunk.point_to_offset(overshoot))
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>è¿™ç§æ²¿ç€ä¸€ä¸ªæˆ–å¤šä¸ªç»´åº¦çš„ç´¯è®¡(æ¦‚è¦!)æ˜¯é€šè¿‡ä¸€äº› <a class="underline underline-offset-5 font-medium" href="https://github.com/zed-industries/zed/blob/6721c91ab000cea73ab30209c4a57bd1e2e2ce56/crates/sum_tree/src/sum_tree.rs#L43-L94">éå¸¸èªæ˜çš„ä»£ç </a> å®ç°çš„, æˆ‘ä¸ä¼šè¯¦ç»†ä»‹ç», ä½†ç®€å•ç‰ˆæœ¬æ˜¯è¿™æ ·çš„:<br>ç»™å®šå¦‚ä¸‹æ‰€ç¤ºçš„ <code class="font-semibold text-[#aa8bd5]"><code>TextSummary</code></code>(æˆ‘ä»¬åœ¨ä¸Šé¢å·²ç»å®Œæ•´çœ‹è¿‡äº†), ä¸ä¸€ä¸ªåŒ…è£…å®ƒçš„ <code class="font-semibold text-[#aa8bd5]"><code>ChunkSummary</code></code>:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">struct TextSummary {
    len: usize,
    lines: Point,
 
    // [...]
}
 
struct ChunkSummary {
    text: TextSummary,
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>æˆ‘ä»¬å¯ä»¥å°† <code class="font-semibold text-[#aa8bd5]"><code>len</code></code> ä¸ <code class="font-semibold text-[#aa8bd5]"><code>lines</code></code> å­—æ®µå®šä¹‰ä¸º <code class="font-semibold text-[#aa8bd5]"><code>sum_tree::Dimensions</code></code>:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">impl&lt;'a> sum_tree::Dimension&lt;'a, ChunkSummary> for usize {
    fn add_summary(&amp;mut self, summary: &amp;'a ChunkSummary, _: &amp;()) {
        *self += summary.text.len;
    }
}
 
impl&lt;'a> sum_tree::Dimension&lt;'a, ChunkSummary> for Point {
    fn add_summary(&amp;mut self, summary: &amp;'a ChunkSummary, _: &amp;()) {
        *self += summary.text.lines;
    }
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>éšå, æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™å®šçš„ <code class="font-semibold text-[#aa8bd5]"><code>sum_tree::D</code></code> æˆ–ä¸€ä¸ªå…³äºç»´åº¦çš„å…ƒç»„(Tuple) æ¥ <a class="underline underline-offset-5 font-medium" href="https://github.com/zed-industries/zed/blob/6721c91ab000cea73ab30209c4a57bd1e2e2ce56/crates/sum_tree/src/sum_tree.rs#L323-L329">æ„é€ cursor</a>(è¿™å°±æ˜¯æˆ‘ä»¬ä¸Šé¢å¯¹ (usize, Point) æ‰€åšçš„)<br><br>æ„é€ å®Œæˆå, cursor å¯ä»¥æ²¿ç€æˆ‘ä»¬å®šä¹‰çš„ä»»ä½• <code class="font-semibold text-[#aa8bd5]"><code>Dimension</code></code> è¿›è¡Œæœç´¢, å¹¶èšåˆ/ç´¯è®¡å®Œæ•´çš„ <code class="font-semibold text-[#aa8bd5]"><code>TextSummary</code></code> æˆ–ç»™å®šæ‘˜è¦ç±»å‹çš„å•ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>Dimension</code></code><br>æˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥æ²¿ç€å•ä¸ªç»´åº¦æœç´¢, ç„¶ååœ¨ cursor æ‰¾åˆ°ç›®æ ‡åè·å–æ•´ä¸ªæ‘˜è¦:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">let mut rope = Rope::new();
rope.push("This is the first line.\n");
rope.push("This is the second line.\n");
rope.push("This is the third line.\n");
 
// Construct cursor:
let mut cursor = rope.cursor(0);
// Seek it to offset 55 and get the `TextSummary` at that offset:
let summary = cursor.summary::&lt;TextSummary>(55);
assert_eq!(summary.len, 55);
assert_eq!(summary.lines, Point::new(2, 6));
assert_eq!(summary.longest_row_chars, 24);</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>cursor åœåœ¨äº†ç¬¬ 2 è¡Œçš„ä¸­é—´, ç¬¬ 6 åˆ—, ç›´åˆ°è¯¥ offset çš„ä½ç½®, å…¶æ‘˜è¦ä¸­çš„ <code class="font-semibold text-[#aa8bd5]"><code>longest_row_chars</code></code> ä¸º 24<br><br>è¿™æ˜¯éå¸¸å¼ºå¤§çš„ä¸œè¥¿, è®©æˆ‘ä»¬å¯ä»¥è½»æ¾åœ¨ UTF-8 æˆ– UTF-16 çš„ (rows, columns) ä¹‹é—´äº’è½¬<br>è¿™åœ¨ä½¿ç”¨ LSP(Language Server Protocal) æœ‰æ—¶æ˜¯ <a class="underline underline-offset-5 font-medium" href="https://matklad.github.io/2023/10/12/lsp-could-have-been-better.html#Coordinates">å¿…éœ€</a> çš„<br><br>æŸ¥æ‰¾ UTF8 çš„ <code class="font-semibold text-[#aa8bd5]"><code>Point</code></code> å¹¶ èšåˆ/ç´¯è®¡ UTF16 çš„ <code class="font-semibold text-[#aa8bd5]"><code>Point</code></code>:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">fn point_to_point_utf16(&amp;self, point: Point) -> PointUtf16 {
    if point >= self.summary().lines {
        return self.summary().lines_utf16();
    }
    let mut cursor = self.chunks.cursor::&lt;(Point, PointUtf16)>();
    cursor.seek(&amp;point, Bias::Left, &amp;());
    // ... you know the rest ...
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>è¿˜æœ‰è®¸å¤šâ€¦â€¦æˆ‘å¯ä»¥ä¸åœåœ°å±•ç¤ºæ›´å¤šä¾‹å­, æˆ–è€…ä½¿ç”¨åƒ <em>monoid homomorphism</em> è¿™æ ·çš„å¤§è¯, ä½†æˆ‘å°±åˆ°æ­¤ä¸ºæ­¢äº†<br>ä½ è¦æ˜ç™½, <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨, å¿«ç…§å‹å¥½, å†™å…¥æ—¶å¤åˆ¶çš„ B+ æ ‘, å®ƒéå¸¸å¼ºå¤§, çµæ´», å¯ä»¥ä¸ä»…ä»…åªæ˜¯ç”¨äºæ–‡æœ¬<br><br>è¿™æ˜¯å®ƒåœ¨ Zed ä¸­æ— å¤„ä¸åœ¨çš„åŸå› , æ˜¯çš„, å­—é¢æ„æ€<br></p>
      <hr class="border-2 border-dashed my-10">
      <h1 class="flex items-center w-fit my-6" id="quan-du-shi-sumtree"><span class="text-2xl mr-2 text-cyan-500">ğŸ”—</span> <a class="text-4xl hover:underline underline-offset-8" href="#quan-du-shi-sumtree">å…¨éƒ½æ˜¯SumTree</a></h1>
      <p>ç›®å‰, <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> åœ¨ Zed ä¸­æœ‰ 20 å¤šç§ç”¨é€”, å…¶ä¸ä»…ç”¨ä½œ <code class="font-semibold text-[#aa8bd5]"><code>Rope</code></code> çš„åŸºç¡€, è€Œä¸”ç”¨äºè®¸å¤šä¸åŒçš„åœ°æ–¹<br>é¡¹ç›®ä¸­çš„æ–‡ä»¶åˆ—è¡¨æ˜¯ä¸€ä¸ª <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code>, git blame è¿”å›çš„ä¿¡æ¯å­˜å‚¨åœ¨ <code class="font-semibold text-[#aa8bd5]"><code>SumTree</code></code> ä¸­, èŠå¤©é¢‘é“çš„æ¶ˆæ¯, è¿˜æœ‰ä»£ç è¯Šæ–­ç­‰ç­‰â€¦â€¦<br><br>Zed çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªåä¸º <code class="font-semibold text-[#aa8bd5]"><code>DisplayMap</code></code> çš„æ•°æ®ç»“æ„<br>å®ƒåŒ…å«æœ‰å…³ç»™å®šæ–‡æœ¬çš„ buffer è¯¥å¦‚ä½•æ˜¾ç¤ºçš„æ‰€æœ‰ä¿¡æ¯: æŠ˜å çš„ä½ç½®, æ¢è¡Œçš„ä½ç½®, inlay-hints(åµŒå…¥æç¤º)çš„æ˜¾ç¤ºä½ç½®ç­‰:<br></p>
      <pre class="group relative mx-2 sm:mx-6 my-4 border-2 border-slate-500 leading-[1.2em]"><script>
        function copy_code(button) {
          const code = button.parentElement.querySelector('code').innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å¥½å•¦';
            setTimeout(() => button.textContent = 'å¤åˆ¶', 2000);
          });
        }
        function fold_code(button) {
          const code = button.parentElement.querySelector('code');
          const next_fold_state = button.textContent
          if (next_fold_state == 'æŠ˜å ') {
            if (!code.hasAttribute('data-original')) {
              code.setAttribute('data-original', code.innerHTML)
            }
            const lines = code.innerHTML.split('\n')
            const firstLine = lines[0]
            code.innerHTML = firstLine
            // code.style.display = 'none'
            button.textContent = 'å±•å¼€'
          } else {
            const lines = code.getAttribute('data-original')
            // code.style.display = 'block'
            code.innerHTML = lines
            button.textContent = 'æŠ˜å '
          }
        }
      </script><p><code class=" language-rust text-sm sm:text-base">struct DisplayMap {
    /// The buffer that we are displaying.
    buffer: Model&lt;MultiBuffer>,
    /// Decides where the [`Inlay`]s should be displayed.
    inlay_map: InlayMap,
    /// Decides where the fold indicators should be and tracks parts of a source file that are currently folded.
    fold_map: FoldMap,
    /// Keeps track of hard tabs in a buffer.
    tab_map: TabMap,
    /// Handles soft wrapping.
    wrap_map: Model&lt;WrapMap>,
    /// Tracks custom blocks such as diagnostics that should be displayed within buffer.
    block_map: BlockMap,
    /// Regions of text that should be highlighted.
    text_highlights: TextHighlights,
    /// Regions of inlays that should be highlighted.
    inlay_highlights: InlayHighlights,
 
    // [...]
}</code></p><button class="absolute top-2 right-2 hidden group-hover:inline text-xl" onclick="copy_code(this)">å¤åˆ¶</button><button class="absolute top-2 right-16 hidden group-hover:inline text-xl" onclick="fold_code(this)">æŠ˜å </button></pre>
      <p>ä½ çŒœæ€ä¹ˆç€? æ‰€æœ‰è¿™äº›åå°éƒ½ä½¿ç”¨äº† SumTree, åœ¨ä»¥åçš„æ–‡ç« ä¸­, æˆ‘ä»¬å°†æ¢è®¨å®ƒä»¬, ä½†æˆ‘ç°åœ¨æƒ³è¯´çš„æ˜¯:<br><br>Zed çš„è”åˆåˆ›å§‹äººä»¬å¹¶æ²¡æœ‰å†³å®šåœ¨ gap-buffer æˆ– piece-table ä¸Šä½¿ç”¨ rope<br>è€Œæ˜¯ä» SumTree å¼€å§‹, è®¤è¯†åˆ°å®ƒæœ‰å¤šä¹ˆå¼ºå¤§, å¦‚ä½•æ»¡è¶³ Zed çš„è¦æ±‚, ç„¶ååŸºäºå®ƒæ„é€ äº† Rope<br><br>rope å¯èƒ½æ˜¯ Zed çš„å¿ƒè„, ä½† SumTree æ˜¯, å†æ¬¡å¼•ç”¨ Nathan çš„è¯, æ˜¯ <strong><em>Zed çš„çµé­‚</em></strong><br>The rope may be at the heart of Zed, but the SumTree is, to quote Nathan again, <strong><em>the soul of Zed</em></strong>.<br></p>
      <hr class="border-2 border-dashed my-10">
      <div class="flex flex-col sm:mx-2 *:my-2"><a class="flex items-center border-2 border-slate-500 w-full sm:rounded-md hover:border-white  justify-end " href="/posts/zed-blog-translation/crdts" hx-get="/posts/zed-blog-translation/crdts/index.html" hx-target="body" hx-push-url="/posts/zed-blog-translation/crdts" hx-swap="innerHTML show:window:top"><span class="text-2xl sm:text-4xl sm:p-2 pr-2 pl-1 order-last ">></span> <span class="text-xl sm:text-2xl sm:p-2">CRDTs è®©åä½œæ–‡æœ¬ç¼–è¾‘æˆä¸º Zed çš„æ ¸å¿ƒ</span></a></div>
    </div>
  </body>
</html>
